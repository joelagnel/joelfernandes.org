
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchroniz...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/page7/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchronization,
memory models and other kernel internals. I also love contributing to the
upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and
<a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at:
joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p>Look for my name in the kernel git log to find my upstream kernel patches.
Check out <a href="/joel/joel-resume.pdf">my resume</a> for full details of my work
experience. I also actively present at conferences, see a list of my past
<a href="/resources">talks, presentations and publications</a>.</p>

Full list of all blog posts on this site:

<font face="monospace">
 <li>
   <span>25 Jun 2023</span> &nbsp; <a href="/svm/vectors/machinelearning/2023/06/25/svm-vectors.html">SVM and vectors for the curious</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [svmvectorsmachinelearning]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2023</span> &nbsp; <a href="/selinux/debugging/2023/06/10/selinux-procfs.html">SELinux Debugging on ChromeOS</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [selinuxdebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>28 Apr 2023</span> &nbsp; <a href="/rcu/synchronization/2023/04/28/hazard-pointers.html">Understanding Hazard Pointers</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2023</span> &nbsp; <a href="/kernel/stack/2023/04/25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [kernelstack]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Feb 2023</span> &nbsp; <a href="/vim/productivity/2023/02/24/ycm-working.html">Getting YouCompleteMe working for kernel development</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [vimproductivity]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>29 Jan 2023</span> &nbsp; <a href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html">Figuring out herd7 memory models</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [herd7lkmmformalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>13 Nov 2022</span> &nbsp; <a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [timerslinuxkernel]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Oct 2020</span> &nbsp; <a href="/c++/2020/10/25/cpp-ref.html">C++ rvalue references</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [c++]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>06 Mar 2020</span> &nbsp; <a href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html">SRCU state double scan</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusrcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>18 Oct 2019</span> &nbsp; <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [pluscaltla+formalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>02 Sep 2019</span> &nbsp; <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcuschedulerlocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>22 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/22/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxinternals]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>15 Jun 2018</span> &nbsp; <a href="/linux/kernel/rcu/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcu]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2018</span> &nbsp; <a href="/linux/kernel/debugging/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneldebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 May 2018</span> &nbsp; <a href="/linux/kernel/rcu/scheduler/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcuscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>11 Feb 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 Jan 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>01 Jan 2017</span> &nbsp; <a href="/linux/kernel/tracing/armv8/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracingarmv8]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>19 Jun 2016</span> &nbsp; <a href="/linux/kernel/tracing/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>20 Mar 2016</span> &nbsp; <a href="/linux/kernel/scheduler/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Dec 2015</span> &nbsp; <a href="/electronics/embedded/linux/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [electronicsembeddedlinux]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>04 Jun 2014</span> &nbsp; <a href="/linux/embedded/electronics/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxembeddedelectronics]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>07 May 2014</span> &nbsp; <a href="/linux/kernel/locking/2014/05/07/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernellocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Apr 2014</span> &nbsp; <a href="/synchronization/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [synchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Apr 2014</span> &nbsp; <a href="/linux/kernel/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernel]

     !-->
 </li>
</font>

</article>


 <!-- This loops through the paginated posts -->




    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a></h1>
    
    
      <p class="meta">
        









<time datetime="2022-11-13T00:00:00-05:00" pubdate data-updated="true">Nov 13, 2022</time>
        
           | <a href="/timers/linux/kernel/2022/11/13/hrtimer.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/timers/linux/kernel/2022/11/13/hrtimer.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Below are some notes I wrote while studying hrtimer slack behavior (range
timers), which was added to reduce wakeups and save power, in the commit below.
The idea is that:</p>
<ol>
  <li>Normal hrtimers will have both a soft and hard expiry which are equal to each other.</li>
  <li>But hrtimers with timer slack will have a soft expiry and a hard expiry which is the soft expiry + delta.</li>
</ol>

<p>The slack/delay effect is achieved by splitting the execution of the timer
function, and the programming of the next timer event into 2 separate steps.
That is, we execute the timer function as soon as we notice that its soft
expiry has passed (<code class="language-plaintext highlighter-rouge">hrtimer_run_queues()</code>). However, for programming the next
timer interrupt, we only look at the hard expiry (<code class="language-plaintext highlighter-rouge">hrtimer_update_next_event()</code>
-&gt; <code class="language-plaintext highlighter-rouge">__hrtimer_get_next_event()</code> -&gt;
<code class="language-plaintext highlighter-rouge">__hrtimer_next_event_base()</code>-&gt;<code class="language-plaintext highlighter-rouge">hrtimer_get_expires()</code>). As a result, the only
way a slack-based timer will execute before its slack time elapses, is, if
another timer without any slack time gets queued such that it hard-expires
before the slack time of the slack-based timer passes.</p>

<p>The commit containing the original code added for range timers is:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>commit 654c8e0b1c623b156c5b92f28d914ab38c9c2c90
Author: Arjan van de Ven &lt;arjan@linux.intel.com&gt;
Date:   Mon Sep 1 15:47:08 2008 -0700

    hrtimer: turn hrtimers into range timers
   
    this patch turns hrtimers into range timers;
    they have 2 expire points
    1) the soft expire point
    2) the hard expire point
   
    the kernel will do it's regular best effort attempt to get the timer run at
the hard expire point. However, if some other time fires after the soft expire
point, the kernel now has the freedom to fire this timer at this point, and
thus grouping the events and preventing a power-expensive wakeup in the future.
</code></pre></div></div>
<p>The original code seems a bit buggy. I got a bit confused about how/where we
handle the case in <code class="language-plaintext highlighter-rouge">hrtimer_interrupt()</code> where other normal timers that expire
before the slack time elapses, have their next timer interrupt programmed
correctly such that the interrupt goes off before the slack time passes.</p>

<p>To see the issue, consider the case where we have 2 timers queued:</p>

<ol>
  <li>
    <p>The first one soft expires at t = 10, and say it has a slack of 50, so it hard expires at t = 60.</p>
  </li>
  <li>
    <p>The second one is a normal timer, so the soft/hard expiry of it is both at t = 30.</p>
  </li>
</ol>

<p>Now say, an hrtimer interrupt happens at t=5 courtesy of an unrelated expiring
timer. In the below code, we notice that the next expiring timer is (the one
with slack one), which has not soft-expired yet. So we have no reason to run
it. However, we reprogram the next timer interrupt to be t=60 which is its hard
expiry time (this is stored in expires_next to use as the value to program the
next timer interrupt with).  Now we have a big problem, because the timer
expiring at t=30 will not run in time and run much later.</p>

<p>As shown below, the loop in <code class="language-plaintext highlighter-rouge">hrtimer_interrupt()</code> goes through all the active
timers in the timerqueue, <code class="language-plaintext highlighter-rouge">_softexpires</code> is made to be the real expiry, and the
old <code class="language-plaintext highlighter-rouge">_expires</code> now becomes <code class="language-plaintext highlighter-rouge">_softexpires + slack</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       while((node = timerqueue_getnext(&amp;base-&gt;active))) {
              struct hrtimer *timer;

              timer = container_of(node, struct hrtimer, node);

              /*
               * The immediate goal for using the softexpires is
               * minimizing wakeups, not running timers at the
               * earliest interrupt after their soft expiration.
               * This allows us to avoid using a Priority Search
               * Tree, which can answer a stabbing querry for
               * overlapping intervals and instead use the simple
               * BST we already have.
               * We don't add extra wakeups by delaying timers that
               * are right-of a not yet expired timer, because that
               * timer will have to trigger a wakeup anyway.
               */

              if (basenow.tv64 &lt; hrtimer_get_softexpires_tv64(timer)) {
                      ktime_t expires;

                      expires = ktime_sub(hrtimer_get_expires(timer),
                                          base-&gt;offset);
                      if (expires.tv64 &lt; expires_next.tv64)
                              expires_next = expires;
                      break;
              }

              __run_hrtimer(timer, &amp;basenow);
      }
</code></pre></div></div>
<p>However, this seems to be an old kernel issue, as, in upstream v6.0, I believe
the next hrtimer interrupt will be programmed correctly because
<code class="language-plaintext highlighter-rouge">__hrtimer_next_event_base()</code> calls <code class="language-plaintext highlighter-rouge">hrtimer_get_expires()</code> which correctly use
the “hard expiry” times to do the programming.</p>
</div>
  
  


    </article>



<div class="pagination">
  
    <a href="/page6">&laquo; Previous Post</a> &nbsp; &nbsp; &nbsp;
  

  <!-- Don't want numbers.
  
    
      <a href="/">1</a>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <a href="/page5">5</a>
    
  
    
      <a href="/page6">6</a>
    
  
    
      <em>7</em>
    
  
    
      <a href="/page8">8</a>
    
  
    
      <a href="/page9">9</a>
    
  
    
      <a href="/page10">10</a>
    
  
    
      <a href="/page11">11</a>
    
  
    
      <a href="/page12">12</a>
    
  
    
      <a href="/page13">13</a>
    
  
    
      <a href="/page14">14</a>
    
  
    
      <a href="/page15">15</a>
    
  
    
      <a href="/page16">16</a>
    
  
    
      <a href="/page17">17</a>
    
  
    
      <a href="/page18">18</a>
    
  
    
      <a href="/page19">19</a>
    
  
    
      <a href="/page20">20</a>
    
  
    
      <a href="/page21">21</a>
    
  
    
      <a href="/page22">22</a>
    
  
    
      <a href="/page23">23</a>
    
  
    
      <a href="/page24">24</a>
    
  
    
      <a href="/page25">25</a>
    
  
  -->

  
    <a href="/page8">Next Post&raquo;</a>
  
</div>


<!-- div blog-index -->
</div>


<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

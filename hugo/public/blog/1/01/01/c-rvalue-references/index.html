<!DOCTYPE html>


<html class="no-js" lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <title>C&#43;&#43; Rvalue References - JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="The author works in the ChromeOS kernel team, where most of the system libraries, low-level components and user space is written in C&#43;&#43;. Thus the â€¦">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href="http://localhost:1313/blog/1/01/01/c-rvalue-references/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="\/javascripts\/libs\/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
</head>
<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources/">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div></header>

  <div id="main">
    <div id="content">
      
<div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">C&#43;&#43; rvalue references</h1>
    
    
      <p class="meta">
        
        
           | <a href="http://localhost:1313/blog/1/01/01/c-rvalue-references/#disqus_thread"
             data-disqus-identifier="http://localhost:1313/blog/1/01/01/c-rvalue-references/">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>The author works in the ChromeOS kernel team, where most of the system
libraries, low-level components and user space is written in C++. Thus the
writer has no choice but to be familiar with C++. It is not that hard, but some
things are confusing. rvalue references are definitely confusing.</p>
<p>In this post, I wish to document rvalue references by simple examples, before I forget it.</p>
<p>Refer to <a href="https://www.chromium.org/rvalue-references">this article</a> for in-depth coverage on rvalue references.</p>
<p>In a nutshell: An rvalue reference can be used to construct a C++ object
efficiently using a &ldquo;move constructor&rdquo;. This efficiency is achieved by the
object&rsquo;s move constructor by <em>moving</em> the underlying memory of the object
efficiently to the destination instead of a full copy. Typically the move
constructor of the object will copy pointers within the source object into the
destination object, and null the pointer within the source object.</p>
<p>An rvalue reference is denoted by a double ampersand (&amp;&amp;) when you want to
create an rvalue reference as a variable.</p>
<p>For example <code>T &amp;&amp;y;</code> defines a variable y which holds an rvalue reference of
type T. I have almost never seen an rvalue reference variable created this way
in real code. I also have no idea when it can be useful. Almost always they are
created by either of the 2 methods in the next section. These methods create an
&ldquo;unnamed&rdquo; rvalue reference which can be passed to a class&rsquo;s move constructor.</p>
<h2 id="when-is-an-rvalue-reference-created">When is an rvalue reference created?</h2>
<p>In the below example, we create an rvalue reference to a vector, and create
another vector object from this.</p>
<p>This can happen in 2 ways (that I know off):</p>
<h3 id="1-using-stdmove">1. Using std::move</h3>
<p>This converts an lvalue reference to an rvalue reference.</p>
<p>Example:</p>
<pre tabindex="0"><code>#include &lt;iostream&gt;
#include &lt;vector&gt;

int main()
{
    int *px, *py;
    std::vector&lt;int&gt; x = {4,3};
    px = &amp;(x[0]);
 
    // Convert lvalue &#39;x&#39; to rvalue reference and pass
    // it to vector&#39;s overloaded move constructor.
    std::vector&lt;int&gt; y(std::move(x)); 
    py = &amp;(y[0]);

    // Confirm the new vector uses same storage
    printf(&#34;same vector? : %d\n&#34;, px == py); // prints 1
}
</code></pre><h3 id="2-when-returning-something-from-a-function">2. When returning something from a function</h3>
<p>The returned object from the function can be caught as an rvalue reference to that object.</p>
<pre tabindex="0"><code>#include &lt;iostream&gt;
#include &lt;vector&gt;

int *pret;
int *py;

std::vector&lt;int&gt; myf(int a)
{
    vector&lt;int&gt; ret;

    ret.push_back(a * a);

    pret = &amp;(ret[0]);

    // Return is caught as an rvalue ref: vector&lt;int&gt; &amp;&amp;
    return ret;
}

int main()
{
    // Invoke vector&#39;s move constructor.
    std::vector&lt;int&gt; y(myf(4)); 
    py = &amp;(y[0]);

    // Confirm the vectors share the same underlying storage
    printf(&#34;same vector? : %d\n&#34;, pret == py); // prints 1
}
</code></pre><h3 id="note-on-move-asssignment">Note on move asssignment</h3>
<p><a href="https://stackoverflow.com/questions/4986673/c11-rvalues-and-move-semantics-confusion-return-statement">Interestingly</a>,
if you construct vector &lsquo;y&rsquo; using the assignment operator: <code>std::vector&lt;int&gt; y = myf(4);</code>, the compiler may decide to use the move constructor automatically
even though assignment is chosen. I believe this is because of vector&rsquo;s <a href="https://en.cppreference.com/w/cpp/language/move_assignment">move
assignment operator
overload</a>.</p>
<p>Further, the compiler may even not invoke a constructor at all and just perform
RVO (Return Value Optimization).</p>
<h2 id="quiz">Quiz</h2>
<h4 id="question">Question:</h4>
<p>If I create a named rvalue reference using std::move and then use this to
create a vector, the underlying storage of the new vector is different. Why?</p>
<pre tabindex="0"><code>#include &lt;iostream&gt;
#include &lt;vector&gt;

int *pret;
int *py;

std::vector&lt;int&gt; myf(int a)
{
    vector&lt;int&gt; ret;

    ret.push_back(a * a);

    pret = &amp;(ret[0]);

    // Return is caught as an rvalue ref: vector&lt;int&gt; &amp;&amp;
    return ret;
}

int main()
{
    // Invoke vector&#39;s move constructor.
    std::vector&lt;int&gt;&amp;&amp; ref = myf(4);
    std::vector&lt;int&gt; y(ref); 
    py = &amp;(y[0]);

    // Confirm the vectors share the same underlying storage
    printf(&#34;same vector? : %d\n&#34;, pret == py); // prints 0
}
</code></pre><h4 id="answer">Answer</h4>
<p>The answer is: because the value category of the id-expression &lsquo;ref&rsquo; is lvalue,
the copy constructor will be chosen. To use the move constructor, it has to be
<code>std::vector&lt;int&gt; y(std::move(ref));</code>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>rvalue references are confusing and sometimes the compiler can do different
optimizations to cause further confusion. It is best to follow well known
design patterns when designing your code. It may be best to also try to avoid
rvalue references altogether but hopefully this article helps you understand it
a bit more when you come across large C++ code bases.</p>
</div>

  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Joel Fernandes</span></span>
      
      <div class="post-categories">
  
    
      
      <a href="/categories/#c%2b%2b">c&#43;&#43;</a>
      &nbsp;
      
    
  
</div>
    </p>
    
      <div class="sharing">
  
  
  
</div>
    
    <p class="meta">
      
        <a class="basic-alignment left" href="http://localhost:1313/blog/1/01/01/figuring-out-herd7-memory-models/" title="Previous Post: Figuring out herd7 memory models">&laquo; Figuring out herd7 memory models</a>
      
      
        <a class="basic-alignment right" href="http://localhost:1313/blog/1/01/01/bpfd-running-bcc-tools-remotely-across-systems/" title="Next Post: BPFd- Running BCC tools remotely across systems">BPFd- Running BCC tools remotely across systems &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>

</div>

<aside class="sidebar">
  <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="http://localhost:1313/blog/2023/06/25/svm-and-vectors-for-the-curious/">SVM and vectors for the curious</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2018/12/22/dumping-user-and-kernel-stacks-on-kernel-events/">Dumping User and Kernel stacks on Kernel events</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2018/02/10/usdt-for-reliable-userspace-event-tracing/">USDT for reliable Userspace event tracing</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2016/12/31/armv8-flamegraph-and-nmi-support/">ARMv8: flamegraph and NMI support</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2016/06/18/ftrace-events-mechanism/">Ftrace events mechanism</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2016/03/20/tif_need_resched-why-is-it-needed/">TIF_NEED_RESCHED: why is it needed</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2015/12/25/tying-2-voltage-sources/signals-together/">Tying 2 voltage sources/signals together</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2014/06/04/microsd-card-remote-switch/">MicroSD card remote switch</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2014/05/07/linux-spinlock-internals/">Linux Spinlock Internals</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems/">Studying cache-line sharing effects on SMP systems</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/2014/04/22/design-of-fork-followed-by-exec-in-linux/">Design of fork followed by exec in Linux</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/"></a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/bpfd-running-bcc-tools-remotely-across-systems/">BPFd- Running BCC tools remotely across systems</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/c-rvalue-references/">C&#43;&#43; rvalue references</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/categories/">Categories</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/joel/">false</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/figuring-out-herd7-memory-models/">Figuring out herd7 memory models</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/getting-youcompleteme-working-for-kernel-development/">Getting YouCompleteMe working for kernel development</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/gus-global-unbounded-sequences/">GUS (Global Unbounded Sequences)</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/archives/">List of articles</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/making-sense-of-scheduler-deadlocks-in-rcu/">Making sense of scheduler deadlocks in RCU</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/modeling-lack-of-store-ordering-using-pluscal-and-a-wishlist/">Modeling (lack of) store ordering using PlusCal - and a wishlist</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/on-workings-of-hrtimers-slack-time-functionality/">On workings of hrtimer&#39;s slack time functionality</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/powerpc-stack-guard-false-positives-in-linux-kernel/">PowerPC stack guard false positives in Linux kernel</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/rcu-and-dynticks-idle-mode/">RCU and dynticks-idle mode</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/rcu-preempt-what-happens-on-a-context-switch/">RCU-preempt: What happens on a context switch</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/resources/">Resources</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/selinux-debugging-on-chromeos/">SELinux Debugging on ChromeOS</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/single-stepping-the-kernels-c-code/">Single-stepping the kernel&#39;s C code</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/srcu-state-double-scan/">SRCU state double scan</a>
      </li>
    
      <li class="post">
        <a href="http://localhost:1313/blog/1/01/01/understanding-hazard-pointers/">Understanding Hazard Pointers</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>A little something about me.</p>
</section>
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - Joel Fernandes -
  <span class="credit">Powered by <a href="https://gohugo.io">Hugo</a></span>
</p></footer>
  
</body>
</html>
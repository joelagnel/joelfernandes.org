
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Nvidia. My interests are scheduler, RCU, tracing, synchroniz...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/page10/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Nvidia. My interests are scheduler, RCU, tracing, synchronization,
memory models and other kernel internals. I also love contributing to the
upstream Linux kernel and other open source projects. In prior jobs, I worked
at Google, Amazon and TI.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and
<a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at:
joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p>Look for my name in the kernel git log to find my upstream kernel patches.
Check out <a href="/joel/joel-resume.pdf">my resume</a> for full details of my work
experience. I also actively present at conferences, see a list of my past
<a href="/resources">talks, presentations and publications</a>.</p>

Full list of all blog posts on this site:

<font face="monospace">
 <li>
   <span>25 Jun 2023</span> &nbsp; <a href="/svm/vectors/machinelearning/2023/06/25/svm-vectors.html">SVM and vectors for the curious</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [svmvectorsmachinelearning]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2023</span> &nbsp; <a href="/selinux/debugging/2023/06/10/selinux-procfs.html">SELinux Debugging on ChromeOS</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [selinuxdebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>28 Apr 2023</span> &nbsp; <a href="/rcu/synchronization/2023/04/28/hazard-pointers.html">Understanding Hazard Pointers</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2023</span> &nbsp; <a href="/kernel/stack/2023/04/25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [kernelstack]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Feb 2023</span> &nbsp; <a href="/vim/productivity/2023/02/24/ycm-working.html">Getting YouCompleteMe working for kernel development</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [vimproductivity]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>29 Jan 2023</span> &nbsp; <a href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html">Figuring out herd7 memory models</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [herd7lkmmformalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>13 Nov 2022</span> &nbsp; <a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [timerslinuxkernel]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Oct 2020</span> &nbsp; <a href="/c++/2020/10/25/cpp-ref.html">C++ rvalue references</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [c++]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>06 Mar 2020</span> &nbsp; <a href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html">SRCU state double scan</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusrcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>18 Oct 2019</span> &nbsp; <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [pluscaltla+formalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>02 Sep 2019</span> &nbsp; <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcuschedulerlocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>22 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/22/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxinternals]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>15 Jun 2018</span> &nbsp; <a href="/linux/kernel/rcu/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcu]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2018</span> &nbsp; <a href="/linux/kernel/debugging/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneldebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 May 2018</span> &nbsp; <a href="/linux/kernel/rcu/scheduler/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcuscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>11 Feb 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 Jan 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>01 Jan 2017</span> &nbsp; <a href="/linux/kernel/tracing/armv8/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracingarmv8]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>19 Jun 2016</span> &nbsp; <a href="/linux/kernel/tracing/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>20 Mar 2016</span> &nbsp; <a href="/linux/kernel/scheduler/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Dec 2015</span> &nbsp; <a href="/electronics/embedded/linux/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [electronicsembeddedlinux]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>04 Jun 2014</span> &nbsp; <a href="/linux/embedded/electronics/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxembeddedelectronics]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>07 May 2014</span> &nbsp; <a href="/linux/kernel/locking/2014/05/07/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernellocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Apr 2014</span> &nbsp; <a href="/synchronization/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [synchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Apr 2014</span> &nbsp; <a href="/linux/kernel/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernel]

     !-->
 </li>
</font>

</article>


 <!-- This loops through the paginated posts -->




    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a></h1>
    
    
      <p class="meta">
        









<time datetime="2019-10-18T00:00:00-04:00" pubdate data-updated="true">Oct 18, 2019</time>
        
           | <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Message Passing pattern (MP pattern) is shown in the snippet below
(borrowed from LKMM docs). Here, P0 and P1 are 2 CPUs executing some code. P0
stores a message in <code class="language-plaintext highlighter-rouge">buf</code> and then signals to consumers like P1 that the
message is available – by doing a store to <code class="language-plaintext highlighter-rouge">flag</code>. P1 reads <code class="language-plaintext highlighter-rouge">flag</code> and if it
is set, knows that some data is available in <code class="language-plaintext highlighter-rouge">buf</code> and goes ahead and reads it.
However, if <code class="language-plaintext highlighter-rouge">flag</code> is not set, then P1 does nothing else. Without memory
barriers between P0’s stores and P1’s loads, the stores can appear out of order
to P1 (on some systems), thus breaking the pattern. The condition <code class="language-plaintext highlighter-rouge">r1 == 0 and
r2 == 1</code> is a failure in the below code and would violate the condition. Only
after the <code class="language-plaintext highlighter-rouge">flag</code> variable is updated, should P1 be allowed to read the <code class="language-plaintext highlighter-rouge">buf</code>
(“message”).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        int buf = 0, flag = 0;

        P0()
        {
                WRITE_ONCE(buf, 1);
                WRITE_ONCE(flag, 1);
        }

        P1()
        {
                int r1;
                int r2 = 0;

                r1 = READ_ONCE(flag);
                if (r1)
                        r2 = READ_ONCE(buf);
        }
</code></pre></div></div>

<p>Below is a simple program in PlusCal to model the “Message passing” access
pattern and check whether the failure scenario <code class="language-plaintext highlighter-rouge">r1 == 0 and r2 == 1</code> could ever
occur. In PlusCal, we can model the non deterministic out-of-order stores to
<code class="language-plaintext highlighter-rouge">buf</code> and <code class="language-plaintext highlighter-rouge">flag</code> using an <code class="language-plaintext highlighter-rouge">either or</code> block. This makes PlusCal evaluate both
scenarios of stores (store to <code class="language-plaintext highlighter-rouge">buf</code> first and then <code class="language-plaintext highlighter-rouge">flag</code>, or viceversa) during
model checking. The technique used for modeling this non-determinism is similar
to how it is done in Promela/Spin using an “if block” (Refer to Paul McKenney’s
perfbook for details on that).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXTENDS Integers, TLC
(*--algorithm mp_pattern
variables
    buf = 0,
    flag = 0;

process Writer = 1
variables
    begin
e0:
       either
e1:        buf := 1;
e2:        flag := 1;
        or
e3:        flag := 1;
e4:        buf := 1;
        end either;
end process;

process Reader = 2
variables
    r1 = 0,
    r2 = 0;  
    begin
e5:     r1 := flag;
e6:     if r1 = 1 then
e7:         r2 := buf;
        end if;
e8:     assert r1 = 0 \/ r2 = 1;
end process;

end algorithm;*)
</code></pre></div></div>

<p>Sure enough, the <code class="language-plaintext highlighter-rouge">assert r1 = 0 \/ r2 = 1;</code>  fires when the PlusCal program is run through the TLC model checker.</p>

<p>I do find the <code class="language-plaintext highlighter-rouge">either or</code> block clunky, and wish I could just do something like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>non_deterministic {
        buf := 1;
        flag := 1;
}
</code></pre></div></div>
<p>And then, PlusCal should evaluate both store orders. In fact, if I wanted more than 2 stores, then it can get crazy pretty quickly without such a construct. I should try to hack the PlusCal sources soon if I get time, to do exactly this. Thankfully it is open source software.</p>

<p>Other notes:</p>

<ul>
  <li>
    <p>PlusCal is a powerful language that translates to TLA+. TLA+ is to PlusCal what assembler is to C. I do find PlusCal’s syntax to be non-intuitive but that could just be because I am new to it. In particular, I hate having to mark statements with labels if I don’t want them to atomically execute with neighboring statements. In PlusCal, a label is used to mark a statement as an “atomic” entity. A group of statements under a label are all atomic. However, if you don’t specific labels on every statement like I did above (<code class="language-plaintext highlighter-rouge">eX</code>), then everything goes under a neighboring label. I wish PlusCal had an option, where a programmer could add implict labels to all statements, and then add explicit <code class="language-plaintext highlighter-rouge">atomic { }</code> blocks around statements that were indeed atomic. This is similar to how it is done in Promela/Spin.</p>
  </li>
  <li>
    <p>I might try to hack up my own compiler to TLA+ if I can find the time to, or better yet modify PlusCal itself to do what I want. Thankfully the code for the PlusCal translator is open source software.</p>
  </li>
</ul>
</div>
  
  


    </article>



<div class="pagination">
  
    <a href="/page9">&laquo; Previous Post</a> &nbsp; &nbsp; &nbsp;
  

  <!-- Don't want numbers.
  
    
      <a href="/">1</a>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <a href="/page5">5</a>
    
  
    
      <a href="/page6">6</a>
    
  
    
      <a href="/page7">7</a>
    
  
    
      <a href="/page8">8</a>
    
  
    
      <a href="/page9">9</a>
    
  
    
      <em>10</em>
    
  
    
      <a href="/page11">11</a>
    
  
    
      <a href="/page12">12</a>
    
  
    
      <a href="/page13">13</a>
    
  
    
      <a href="/page14">14</a>
    
  
    
      <a href="/page15">15</a>
    
  
    
      <a href="/page16">16</a>
    
  
    
      <a href="/page17">17</a>
    
  
    
      <a href="/page18">18</a>
    
  
    
      <a href="/page19">19</a>
    
  
    
      <a href="/page20">20</a>
    
  
    
      <a href="/page21">21</a>
    
  
    
      <a href="/page22">22</a>
    
  
    
      <a href="/page23">23</a>
    
  
    
      <a href="/page24">24</a>
    
  
    
      <a href="/page25">25</a>
    
  
  -->

  
    <a href="/page11">Next Post&raquo;</a>
  
</div>


<!-- div blog-index -->
</div>


<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Modeling (lack of) store ordering using PlusCal - and a wishlist - JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="

  
  
    
      Modeling (lack of) store ordering using PlusCal - and a wishlist
    
    
      
        









Oct 18, 2019
        
      ...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Modeling (lack of) store ordering using PlusCal - and a wishlist</h1>
    
    
      <p class="meta">
        









<time datetime="2019-10-18T00:00:00-04:00" pubdate data-updated="true">Oct 18, 2019</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>The Message Passing pattern (MP pattern) is shown in the snippet below
(borrowed from LKMM docs). Here, P0 and P1 are 2 CPUs executing some code. P0
stores a message in <code class="language-plaintext highlighter-rouge">buf</code> and then signals to consumers like P1 that the
message is available – by doing a store to <code class="language-plaintext highlighter-rouge">flag</code>. P1 reads <code class="language-plaintext highlighter-rouge">flag</code> and if it
is set, knows that some data is available in <code class="language-plaintext highlighter-rouge">buf</code> and goes ahead and reads it.
However, if <code class="language-plaintext highlighter-rouge">flag</code> is not set, then P1 does nothing else. Without memory
barriers between P0’s stores and P1’s loads, the stores can appear out of order
to P1 (on some systems), thus breaking the pattern. The condition <code class="language-plaintext highlighter-rouge">r1 == 0 and
r2 == 1</code> is a failure in the below code and would violate the condition. Only
after the <code class="language-plaintext highlighter-rouge">flag</code> variable is updated, should P1 be allowed to read the <code class="language-plaintext highlighter-rouge">buf</code>
(“message”).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        int buf = 0, flag = 0;

        P0()
        {
                WRITE_ONCE(buf, 1);
                WRITE_ONCE(flag, 1);
        }

        P1()
        {
                int r1;
                int r2 = 0;

                r1 = READ_ONCE(flag);
                if (r1)
                        r2 = READ_ONCE(buf);
        }
</code></pre></div></div>

<p>Below is a simple program in PlusCal to model the “Message passing” access
pattern and check whether the failure scenario <code class="language-plaintext highlighter-rouge">r1 == 0 and r2 == 1</code> could ever
occur. In PlusCal, we can model the non deterministic out-of-order stores to
<code class="language-plaintext highlighter-rouge">buf</code> and <code class="language-plaintext highlighter-rouge">flag</code> using an <code class="language-plaintext highlighter-rouge">either or</code> block. This makes PlusCal evaluate both
scenarios of stores (store to <code class="language-plaintext highlighter-rouge">buf</code> first and then <code class="language-plaintext highlighter-rouge">flag</code>, or viceversa) during
model checking. The technique used for modeling this non-determinism is similar
to how it is done in Promela/Spin using an “if block” (Refer to Paul McKenney’s
perfbook for details on that).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXTENDS Integers, TLC
(*--algorithm mp_pattern
variables
    buf = 0,
    flag = 0;

process Writer = 1
variables
    begin
e0:
       either
e1:        buf := 1;
e2:        flag := 1;
        or
e3:        flag := 1;
e4:        buf := 1;
        end either;
end process;

process Reader = 2
variables
    r1 = 0,
    r2 = 0;  
    begin
e5:     r1 := flag;
e6:     if r1 = 1 then
e7:         r2 := buf;
        end if;
e8:     assert r1 = 0 \/ r2 = 1;
end process;

end algorithm;*)
</code></pre></div></div>

<p>Sure enough, the <code class="language-plaintext highlighter-rouge">assert r1 = 0 \/ r2 = 1;</code>  fires when the PlusCal program is run through the TLC model checker.</p>

<p>I do find the <code class="language-plaintext highlighter-rouge">either or</code> block clunky, and wish I could just do something like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>non_deterministic {
        buf := 1;
        flag := 1;
}
</code></pre></div></div>
<p>And then, PlusCal should evaluate both store orders. In fact, if I wanted more than 2 stores, then it can get crazy pretty quickly without such a construct. I should try to hack the PlusCal sources soon if I get time, to do exactly this. Thankfully it is open source software.</p>

<p>Other notes:</p>

<ul>
  <li>
    <p>PlusCal is a powerful language that translates to TLA+. TLA+ is to PlusCal what assembler is to C. I do find PlusCal’s syntax to be non-intuitive but that could just be because I am new to it. In particular, I hate having to mark statements with labels if I don’t want them to atomically execute with neighboring statements. In PlusCal, a label is used to mark a statement as an “atomic” entity. A group of statements under a label are all atomic. However, if you don’t specific labels on every statement like I did above (<code class="language-plaintext highlighter-rouge">eX</code>), then everything goes under a neighboring label. I wish PlusCal had an option, where a programmer could add implict labels to all statements, and then add explicit <code class="language-plaintext highlighter-rouge">atomic { }</code> blocks around statements that were indeed atomic. This is similar to how it is done in Promela/Spin.</p>
  </li>
  <li>
    <p>I might try to hack up my own compiler to TLA+ if I can find the time to, or better yet modify PlusCal itself to do what I want. Thankfully the code for the PlusCal translator is open source software.</p>
  </li>
</ul>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Joel Fernandes</span></span>

      









<time datetime="2019-10-18T00:00:00-04:00" pubdate data-updated="true">Oct 18, 2019</time>
      <!--
  Borrowed from: https://blog.webjeda.com/jekyll-categories/
  Added on 1/29/2023
-->
<div class="post-categories">
  
  
  <a href="/categories/#pluscal">pluscal</a>
  &nbsp;
  
  <a href="/categories/#tla+">tla+</a>
  &nbsp;
  
  <a href="/categories/#formalmethods">formalmethods</a>
  
  
</div>

<!--
Commented out on 1/29/2023:



<span class="categories">
  
    pluscaltla+formalmethods
  
  </span>

 -->

    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html" title="Previous Post: Making sense of scheduler deadlocks in RCU">&laquo; Making sense of scheduler deadlocks in RCU</a>
      
      
        <a class="basic-alignment right" href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html" title="Next Post: SRCU state double scan">SRCU state double scan &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.linuxinternals.org/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html';
        var disqus_url = 'http://www.linuxinternals.org/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

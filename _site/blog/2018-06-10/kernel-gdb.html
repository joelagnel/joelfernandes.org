<!DOCTYPE html>
<html>
<head>
<title>Single-stepping the kernel's C code - Joel Fernandes</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="author" content="Joel Fernandes">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/page.css">
<link rel="stylesheet" href="/css/syntax.css">
<link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div class="page">

<div class="nav">
<p class="navhdr">Joel's site:</p>
<a href="/">Home</a><br>
<a href="/joel/">Resume</a><br>
<a href="/technical.html">Technical Posts</a><br>
<a href="/personal.html">Personal Posts</a><br>
</div>

<div class="recent">
<p class="navhdr">Recent technical posts:</p>
<ul>






<li class="recent">2026-02-08 &raquo;<br><a href="/blog/2026-02-08/rust-clist-kernel.html">CList: Iterating C Linked Lists from Rust in the Kernel</a></li>






<li class="recent">2023-06-25 &raquo;<br><a href="/blog/2023-06-25/svm-vectors.html">SVM and vectors for the curious</a></li>






<li class="recent">2023-06-10 &raquo;<br><a href="/blog/2023-06-10/selinux-procfs.html">SELinux Debugging on ChromeOS</a></li>






<li class="recent">2023-04-28 &raquo;<br><a href="/blog/2023-04-28/hazard-pointers.html">Understanding Hazard Pointers</a></li>






<li class="recent">2023-04-25 &raquo;<br><a href="/blog/2023-04-25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a></li>






<li class="recent">2023-02-24 &raquo;<br><a href="/blog/2023-02-24/ycm-working.html">Getting YouCompleteMe working for kernel development</a></li>






<li class="recent">2023-01-29 &raquo;<br><a href="/blog/2023-01-29/figuring-out-herd7.html">Figuring out herd7 memory models</a></li>






<li class="recent">2022-12-15 &raquo;<br><a href="/blog/2022-12-15/modeling-condition-variables.html">Modeling Condition Variables using Formal Methods</a></li>






<li class="recent">2022-11-13 &raquo;<br><a href="/blog/2022-11-13/hrtimer.html">On workings of hrtimer's slack time functionality</a></li>






<li class="recent">2020-10-25 &raquo;<br><a href="/blog/2020-10-25/cpp-ref.html">C++ rvalue references</a></li>












































































</ul>

<hr>

<p class="navhdr">Recent personal posts:</p>
<ul>




<li class="recent">2026-02-10 &raquo;<br><a href="/blog/2026-02-10/new-york-trip.html">New York Trip - Celebrating 40</a></li>




























































</ul>

<hr>

<p><a href="/technical.html">All technical posts</a><br>
<a href="/personal.html">All personal posts</a></p>
</div>

<div class="site">

<p><a href="/">&laquo; Back to Home</a></p>

<h1 class="title">Single-stepping the kernel's C code</h1>
<p class="meta">10 Jun 2018</p>

<div class="post">
<p>Recently, I have had to use the GNU debugger (gdb) connected to a Qemu instance
of a RISC-V processor to step through some kernel code.</p>

<p>Turns out that the Linux kernel is compiled with gcc <code class="language-plaintext highlighter-rouge">-O2</code> flag for
optimizations it needs during the build. This causes several problems for a
debugger.  One of them is that the gdb command <code class="language-plaintext highlighter-rouge">info registers</code> will show
values as <code class="language-plaintext highlighter-rouge">&lt;optimized out&gt;</code>. Another issue is that single-stepping will make
the debugger appear to jump back and forth across lines of code as code is
stepped through with <code class="language-plaintext highlighter-rouge">next</code> or <code class="language-plaintext highlighter-rouge">step</code> gdb commands.</p>

<p>To circumvent this issue, I ended up with a hack that works well. I don’t claim
this is recommended or correct, but it makes it through the build and gdb works
fine. In my debugging, I have wanted to single-step through scheduler code in
the <code class="language-plaintext highlighter-rouge">__schedule</code> kernel function. For this purpose, all I have to do is add the
following to <code class="language-plaintext highlighter-rouge">kernel/sched/Makefile</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CFLAGS_REMOVE_core.o := -O2
CFLAGS_core.o := -O0
</code></pre></div></div>
<p>This works brilliantly! What do you think? Let me know in the comments.</p>

<p>Some more tips:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CONFIG_DEBUG_INFO</code> is needed to ensure kernel has debug symbols for gdb to
load, and ofcourse <code class="language-plaintext highlighter-rouge">CONFIG_DEBUG_KERNEL</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">CONFIG_FRAME_POINTER</code> should be enabled to ensure stack unwinding,
backtraces work correctly.</li>
  <li><code class="language-plaintext highlighter-rouge">CONFIG_GDB_SCRIPTS</code> is a bunch of useful gdb scripts automatically load when a
vmlinux is gdb’d.</li>
</ul>


</div>

<p><a href="/">&laquo; Back to Home</a></p>

<hr>
<h2>Comments</h2>
<script src="https://utteranc.es/client.js"
        repo="joelagnel/joelfernandes.org"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


<div class="footer">
<div class="contact">
<p>© Joel Fernandes · <a href="https://twitter.com/joel_linux">Twitter</a> · <a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a> · <a href="/about-site.html">About site</a></p>
</div>
</div>

</div>

</div>

</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>On workings of hrtimer's slack time functionality - JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="

  
  
    
      On workings of hrtimer's slack time functionality
    
    
      
        









Nov 13, 2022
        
           | Comments...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/timers/linux/kernel/2022/11/13/hrtimer.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">On workings of hrtimer's slack time functionality</h1>
    
    
      <p class="meta">
        









<time datetime="2022-11-13T00:00:00-05:00" pubdate data-updated="true">Nov 13, 2022</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Below are some notes I wrote while studying hrtimer slack behavior (range
timers), which was added to reduce wakeups and save power, in the commit below.
The idea is that:</p>
<ol>
  <li>Normal hrtimers will have both a soft and hard expiry which are equal to each other.</li>
  <li>But hrtimers with timer slack will have a soft expiry and a hard expiry which is the soft expiry + delta.</li>
</ol>

<p>The slack/delay effect is achieved by splitting the execution of the timer
function, and the programming of the next timer event into 2 separate steps.
That is, we execute the timer function as soon as we notice that its soft
expiry has passed (<code class="language-plaintext highlighter-rouge">hrtimer_run_queues()</code>). However, for programming the next
timer interrupt, we only look at the hard expiry (<code class="language-plaintext highlighter-rouge">hrtimer_update_next_event()</code>
-&gt; <code class="language-plaintext highlighter-rouge">__hrtimer_get_next_event()</code> -&gt;
<code class="language-plaintext highlighter-rouge">__hrtimer_next_event_base()</code>-&gt;<code class="language-plaintext highlighter-rouge">hrtimer_get_expires()</code>). As a result, the only
way a slack-based timer will execute before its slack time elapses, is, if
another timer without any slack time gets queued such that it hard-expires
before the slack time of the slack-based timer passes.</p>

<p>The commit containing the original code added for range timers is:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>commit 654c8e0b1c623b156c5b92f28d914ab38c9c2c90
Author: Arjan van de Ven &lt;arjan@linux.intel.com&gt;
Date:   Mon Sep 1 15:47:08 2008 -0700

    hrtimer: turn hrtimers into range timers
   
    this patch turns hrtimers into range timers;
    they have 2 expire points
    1) the soft expire point
    2) the hard expire point
   
    the kernel will do it's regular best effort attempt to get the timer run at
the hard expire point. However, if some other time fires after the soft expire
point, the kernel now has the freedom to fire this timer at this point, and
thus grouping the events and preventing a power-expensive wakeup in the future.
</code></pre></div></div>
<p>The original code seems a bit buggy. I got a bit confused about how/where we
handle the case in <code class="language-plaintext highlighter-rouge">hrtimer_interrupt()</code> where other normal timers that expire
before the slack time elapses, have their next timer interrupt programmed
correctly such that the interrupt goes off before the slack time passes.</p>

<p>To see the issue, consider the case where we have 2 timers queued:</p>

<ol>
  <li>
    <p>The first one soft expires at t = 10, and say it has a slack of 50, so it hard expires at t = 60.</p>
  </li>
  <li>
    <p>The second one is a normal timer, so the soft/hard expiry of it is both at t = 30.</p>
  </li>
</ol>

<p>Now say, an hrtimer interrupt happens at t=5 courtesy of an unrelated expiring
timer. In the below code, we notice that the next expiring timer is (the one
with slack one), which has not soft-expired yet. So we have no reason to run
it. However, we reprogram the next timer interrupt to be t=60 which is its hard
expiry time (this is stored in expires_next to use as the value to program the
next timer interrupt with).  Now we have a big problem, because the timer
expiring at t=30 will not run in time and run much later.</p>

<p>As shown below, the loop in <code class="language-plaintext highlighter-rouge">hrtimer_interrupt()</code> goes through all the active
timers in the timerqueue, <code class="language-plaintext highlighter-rouge">_softexpires</code> is made to be the real expiry, and the
old <code class="language-plaintext highlighter-rouge">_expires</code> now becomes <code class="language-plaintext highlighter-rouge">_softexpires + slack</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       while((node = timerqueue_getnext(&amp;base-&gt;active))) {
              struct hrtimer *timer;

              timer = container_of(node, struct hrtimer, node);

              /*
               * The immediate goal for using the softexpires is
               * minimizing wakeups, not running timers at the
               * earliest interrupt after their soft expiration.
               * This allows us to avoid using a Priority Search
               * Tree, which can answer a stabbing querry for
               * overlapping intervals and instead use the simple
               * BST we already have.
               * We don't add extra wakeups by delaying timers that
               * are right-of a not yet expired timer, because that
               * timer will have to trigger a wakeup anyway.
               */

              if (basenow.tv64 &lt; hrtimer_get_softexpires_tv64(timer)) {
                      ktime_t expires;

                      expires = ktime_sub(hrtimer_get_expires(timer),
                                          base-&gt;offset);
                      if (expires.tv64 &lt; expires_next.tv64)
                              expires_next = expires;
                      break;
              }

              __run_hrtimer(timer, &amp;basenow);
      }
</code></pre></div></div>
<p>However, this seems to be an old kernel issue, as, in upstream v6.0, I believe
the next hrtimer interrupt will be programmed correctly because
<code class="language-plaintext highlighter-rouge">__hrtimer_next_event_base()</code> calls <code class="language-plaintext highlighter-rouge">hrtimer_get_expires()</code> which correctly use
the “hard expiry” times to do the programming.</p>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Joel Fernandes</span></span>

      









<time datetime="2022-11-13T00:00:00-05:00" pubdate data-updated="true">Nov 13, 2022</time>
      <!--
  Borrowed from: https://blog.webjeda.com/jekyll-categories/
  Added on 1/29/2023
-->
<div class="post-categories">
  
  
  <a href="/categories/#timers">timers</a>
  &nbsp;
  
  <a href="/categories/#linux">linux</a>
  &nbsp;
  
  <a href="/categories/#kernel">kernel</a>
  
  
</div>

<!--
Commented out on 1/29/2023:



<span class="categories">
  
    timerslinuxkernel
  
  </span>

 -->

    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/c++/2020/10/25/cpp-ref.html" title="Previous Post: C++ rvalue references">&laquo; C++ rvalue references</a>
      
      
        <a class="basic-alignment right" href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html" title="Next Post: Figuring out herd7 memory models">Figuring out herd7 memory models &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.linuxinternals.org/timers/linux/kernel/2022/11/13/hrtimer.html';
        var disqus_url = 'http://www.linuxinternals.org/timers/linux/kernel/2022/11/13/hrtimer.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

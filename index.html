
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and I run this site! I work in the Android kernel team at Google. My interests are scheduler, tracing, synchronization and kerne...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
    <h2>My dumping ground for what I've been upto</h2>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <a href="/linuxinternals/">Linux Internals Articles</a><br>
 <a href="/blog/archives/">All blog posts</a><br>
 <a href="/resources">Talks and resources</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>

<!-- div style="position:absolute; top: 170px" class="hnavtitle" -->
<!-- a><font size="2">If you solve world hunger, and make a driver that cures people of cancer, by all means enable it by default.
— Linus Torvalds</font></a -->
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
<!-- /div -->

</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and I run this site! I work in the Android kernel team at Google. My interests are scheduler, tracing, synchronization and kernel internals. I also love contributing to the upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and <a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at: joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p><a href="https://patchwork.kernel.org/project/LKML/list/?submitter=170577">Here’s a list</a> of recent kernel patches I submitted. I got <a href="http://hackaday.com/2014/06/08/the-in-circuit-sd-card-switch/">featured on hackaday</a> and <a href="https://lwn.net/Articles/744522/">have written for LWN</a> as well. <a href="/joel/joel-resume.pdf">Check out my resume</a> and also see a list of past <a href="/resources">talks/presentations</a>.</p>

<p><strong><a href="/linuxinternals/">LinuxInternals.org</a></strong> is a resource I created as a collection of articles and resources exploring Linux kernel and internals topics.</p>


Full list of all posts on this site:

<font face="monospace">
 <li><span>22 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/22/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>15 Jun 2018</span> &nbsp; <a href="/linuxinternals/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>10 Jun 2018</span> &nbsp; <a href="/linux/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a>  [linux] </li>
</font>

<font face="monospace">
 <li><span>10 May 2018</span> &nbsp; <a href="/linuxinternals/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>11 Feb 2018</span> &nbsp; <a href="/linuxinternals/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>08 Jan 2018</span> &nbsp; <a href="/linuxinternals/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>01 Jan 2017</span> &nbsp; <a href="/linuxinternals/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>19 Jun 2016</span> &nbsp; <a href="/linuxinternals/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>20 Mar 2016</span> &nbsp; <a href="/linuxinternals/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>25 Dec 2015</span> &nbsp; <a href="/electronics,linuxinternals/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a>  [electronics,linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>04 Jun 2014</span> &nbsp; <a href="/linuxinternals/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>07 May 2014</span> &nbsp; <a href="/linuxinternals/2014/05/07/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>24 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>23 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a>  [linuxinternals] </li>
</font>

</article>

  
  
  
    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/linuxinternals/2018/12/22/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a></h1>
    
    
      <p class="meta">
        









<time datetime="2018-12-22T20:28:24-05:00" pubdate data-updated="true">Dec 22, 2018</time>
        
           | <a href="/linuxinternals/2018/12/22/stack-dumps.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/linuxinternals/2018/12/22/stack-dumps.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Dumping the native kernel and userspace stack when a certain path in the kernel
or userspace occurs, can be useful to understand which code paths triggered a
certain behavior that you’re trying to debug, such as an error you found in the
log. One such case is when you notice Selinux denial messages in logs but want
to know which path triggered it.</p>

<p>In this article we will show you how to use kernel instrumentation and BCC to
dump the both the user and kernel stack. The article applies both to Android
and regular Linux kernels.</p>

<h2 id="example-understanding-which-path-triggered-an-selinux-denial">Example: Understanding which path triggered an SELinux denial</h2>

<h3 id="step-1-add-a-tracepoint-to-the-kernel">Step 1: Add a tracepoint to the kernel</h3>
<p>Apply the following diff to your kernel. It adds a tracepoint at precisely the
point where an SELinux denial is logged. If not cleanly applying, patch it in
manually.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Diff to add a tracepoint for selinux denials

diff --git a/include/trace/events/selinux.h b/include/trace/events/selinux.h
new file mode 100644
index 000000000000..dac185062634
--- /dev/null
+++ b/include/trace/events/selinux.h
@@ -0,0 +1,34 @@
+#undef TRACE_SYSTEM
+#define TRACE_SYSTEM selinux
+
+#if !defined(_TRACE_SELINUX_H) || defined(TRACE_HEADER_MULTI_READ)
+#define _TRACE_SELINUX_H
+
+#include &lt;linux/ktime.h&gt;
+#include &lt;linux/tracepoint.h&gt;
+
+TRACE_EVENT(selinux_denied,
+
+	TP_PROTO(int cls, int av),
+
+	TP_ARGS(cls, av),
+
+	TP_STRUCT__entry(
+		__field(	int,		cls	)
+		__field(	int,		av	)
+	),
+
+	TP_fast_assign(
+		__entry-&gt;cls = cls;
+		__entry-&gt;av = av;
+	),
+
+	TP_printk("denied %d %d",
+		__entry-&gt;cls,
+		__entry-&gt;av)
+);
+
+#endif /* _TRACE_SELINUX_H */
+
+/* This part ust be outside protection */
+#include &lt;trace/define_trace.h&gt;
diff --git a/security/selinux/avc.c b/security/selinux/avc.c
index 84d9a2e2bbaf..ab04b7c2dd01 100644
--- a/security/selinux/avc.c
+++ b/security/selinux/avc.c
@@ -34,6 +34,9 @@
 #include "avc_ss.h"
 #include "classmap.h"
 
+#define CREATE_TRACE_POINTS
+#include &lt;trace/events/selinux.h&gt;
+
 #define AVC_CACHE_SLOTS			512
 #define AVC_DEF_CACHE_THRESHOLD		512
 #define AVC_CACHE_RECLAIM		16
@@ -713,6 +716,12 @@ static void avc_audit_pre_callback(struct audit_buffer *ab, void *a)
 	struct common_audit_data *ad = a;
 	audit_log_format(ab, "avc:  %s ",
 			 ad-&gt;selinux_audit_data-&gt;denied ? "denied" : "granted");
+
+	if (ad-&gt;selinux_audit_data-&gt;denied) {
+		trace_selinux_denied(ad-&gt;selinux_audit_data-&gt;tclass,
+				     ad-&gt;selinux_audit_data-&gt;audited);
+	}
+
 	avc_dump_av(ab, ad-&gt;selinux_audit_data-&gt;tclass,
 			ad-&gt;selinux_audit_data-&gt;audited);
 	audit_log_format(ab, " for ");
</code></pre></div></div>

<h3 id="step-2-install-adeb">Step 2: Install <a href="https://github.com/joelagnel/adeb">adeb</a></h3>
<p>Run the command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adeb prepare --full
</code></pre></div></div>
<p>This also installs BCC on the Android device which contains the ‘trace’ utility
we need for the next step. For regular Linux kernels, you may have to <a href="https://github.com/joelagnel/bcc/blob/master/README.md">manually
install BCC</a> or find a
package for it.</p>

<h3 id="step-3-start-tracing-the-user-and-kernel-stacks">Step 3: Start tracing the user and kernel stacks</h3>
<p>Running the following command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adeb shell
trace -K -U 't:selinux:selinux_denial'
</code></pre></div></div>

<p>You should see something like this when denials are triggered:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2286    2434    Binder:2286_4   selinux_denied   

        avc_audit_pre_callback+0xd8 [kernel]
        avc_audit_pre_callback+0xd8 [kernel]
        common_lsm_audit+0x64 [kernel]
        slow_avc_audit+0x74 [kernel]
        avc_has_perm+0xb8 [kernel]
        selinux_binder_transfer_file+0x158 [kernel]
        security_binder_transfer_file+0x50 [kernel]
        binder_translate_fd+0xcc [kernel]
        binder_transaction+0x1b64 [kernel]
        binder_ioctl+0xadc [kernel]
        do_vfs_ioctl+0x5c8 [kernel]
        sys_ioctl+0x88 [kernel]
        __sys_trace_return+0x0 [kernel]
        __ioctl+0x8 [libc.so]
        android::IPCThreadState::talkWithDriver(bool)+0x104 [libbinder.so]
        android::IPCThreadState::waitForResponse(android::Parcel*, int*)+0x40
                                                            [libbinder.so]
        android::IPCThreadState::executeCommand(int)+0x460 [libbinder.so]
        android::IPCThreadState::getAndExecuteCommand()+0xa0 [libbinder.so]
        android::IPCThreadState::joinThreadPool(bool)+0x40 [libbinder.so]
        [unknown] [libbinder.so]
        android::Thread::_threadLoop(void*)+0x12c [libutils.so]
        android::AndroidRuntime::javaThreadShell(void*)+0x90 [libandroid_runtime.so]
        __pthread_start(void*)+0x28 [libc.so]
        __start_thread+0x48 [libc.so]
</code></pre></div></div>

<p>The same trick can be used for dumping the stack on syscalls, random kernel
functions using kprobes and more! Just change the arguments passed to the
‘trace’ command.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

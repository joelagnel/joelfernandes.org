
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchroniz...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/page6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchronization,
memory models and other kernel internals. I also love contributing to the
upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and
<a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at:
joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p>Look for my name in the kernel git log to find my upstream kernel patches.
Check out <a href="/joel/joel-resume.pdf">my resume</a> for full details of my work
experience. I also actively present at conferences, see a list of my past
<a href="/resources">talks, presentations and publications</a>.</p>

Full list of all blog posts on this site:

<font face="monospace">
 <li>
   <span>29 Jan 2023</span> &nbsp; <a href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html">Figuring out herd7 memory models</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [herd7lkmmformalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>13 Nov 2022</span> &nbsp; <a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [timerslinuxkernel]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Oct 2020</span> &nbsp; <a href="/c++/2020/10/25/cpp-ref.html">C++ rvalue references</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [c++]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>06 Mar 2020</span> &nbsp; <a href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html">SRCU state double scan</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusrcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>18 Oct 2019</span> &nbsp; <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [pluscaltla+formalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>02 Sep 2019</span> &nbsp; <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcuschedulerlocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/23/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxinternals]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>15 Jun 2018</span> &nbsp; <a href="/linux/kernel/rcu/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcu]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2018</span> &nbsp; <a href="/linux/kernel/debugging/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneldebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 May 2018</span> &nbsp; <a href="/linux/kernel/rcu/scheduler/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcuscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>11 Feb 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 Jan 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>01 Jan 2017</span> &nbsp; <a href="/linux/kernel/tracing/armv8/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracingarmv8]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>19 Jun 2016</span> &nbsp; <a href="/linux/kernel/tracing/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>20 Mar 2016</span> &nbsp; <a href="/linux/kernel/scheduler/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Dec 2015</span> &nbsp; <a href="/electronics/embedded/linux/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [electronicsembeddedlinux]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>04 Jun 2014</span> &nbsp; <a href="/linux/embedded/electronics/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxembeddedelectronics]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 May 2014</span> &nbsp; <a href="/linux/kernel/locking/2014/05/08/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernellocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2014</span> &nbsp; <a href="/synchronization/2014/04/25/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [synchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Apr 2014</span> &nbsp; <a href="/linux/kernel/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernel]

     !-->
 </li>
</font>

</article>


 <!-- This loops through the paginated posts -->




    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a></h1>
    
    
      <p class="meta">
        









<time datetime="2019-09-02T00:00:00+00:00" pubdate data-updated="true">Sep 02, 2019</time>
        
           | <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Note: At the time of this writing, it is kernel v5.3 release. RCU moves fast
and can change in the future, so some details in this article may be obsolete.</p>

<p>The RCU subsystem and the task scheduler are inter-dependent. They both depend
on each other to function correctly. The scheduler has many data structures
that are protected by RCU. And, RCU may need to wake up threads to perform
things like completing grace periods and callback execution. One such case
where RCU does a wake up and enters the scheduler is
<code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code>.</p>

<p>Recently Paul McKenney consolidated RCU flavors. What does this mean?</p>

<p>Consider the following code executing in CPU 0:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>preempt_disable();
rcu_read_lock();
rcu_read_unlock();
preempt_enable();
</code></pre></div></div>
<p>And, consider the following code executing in CPU 1:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a = 1;
synchronize_rcu();  // Assume synchronize_rcu
                    // executes after CPU0's rcu_read_lock
b = 2;
</code></pre></div></div>
<p>CPU 0’s execution path shows 2 flavors of RCU readers, one nested into another.
The <code class="language-plaintext highlighter-rouge">preempt_{disable,enable}</code> pair is an <code class="language-plaintext highlighter-rouge">RCU-sched</code> flavor RCU reader
section, while the <code class="language-plaintext highlighter-rouge">rcu_read_{lock,unlock}</code> pair is an <code class="language-plaintext highlighter-rouge">RCU-preempt</code> flavor RCU
reader section.</p>

<p>In older kernels (before v4.20), CPU 1’s <code class="language-plaintext highlighter-rouge">synchronize_rcu()</code>  could return
<em>after</em> CPU 0’s <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> but before CPU 0’s <code class="language-plaintext highlighter-rouge">preempt_enable()</code>. This
is because <code class="language-plaintext highlighter-rouge">synchronize_rcu()</code> only needs to wait for the “RCU-preempt” flavor
of the RCU grace period to end.</p>

<p>In newer kernels (v4.20 and above), the RCU-preempt and RCU-sched flavors have
been consolidated. This means CPU 1’s <code class="language-plaintext highlighter-rouge">synchronize_rcu()</code> is guaranteed to wait
for both of CPU 1’s <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> and <code class="language-plaintext highlighter-rouge">preempt_enable()</code> to complete.</p>

<p>Now, lets get a bit more detailed. That <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> most likely does
very little. However, there are cases where it needs to do more, by calling
<code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code>. One such case is if the reader section was
preempted. A few more cases are:</p>

<ul>
  <li>The RCU reader is blocking an expedited grace period, so it needed to report
a quiescent state quickly.</li>
  <li>The RCU reader is blocking a grace period for too long (~100 jiffies on my
system, that’s the default but can be set with
<code class="language-plaintext highlighter-rouge">rcutree.jiffies_till_sched_qs</code> parameter).</li>
</ul>

<p>In all these cases, the <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> needs to do more work. However,
care must be taken when calling <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> from the scheduler, that’s
why this article on scheduler deadlocks.</p>

<p>One of the reasons <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> needs to call into the scheduler
is priority de-boosting:  A task getting preempted in the middle of an RCU
read-side critical section results in blocking the completion of the critical
section and hence could prevent current and future grace periods from ending.
So the priority of the RCU reader may need to be boosted so that it gets enough
CPU time to make progress, and have the grace period end soon. But it also
needs to be de-boosted after the reader section completes. This de-boosting
happens by calling of the <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> function in the outer
most <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code>.</p>

<p>What could go wrong with the scheduler using RCU? Let us see this in action.
Consider the following piece of code executed in the scheduler:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  reader()
	{
		rcu_read_lock();
		do_something();     // Preemption happened
                /* Preempted task got boosted */
		task_rq_lock();     // Disables interrupts
                rcu_read_unlock();  // Need to de-boost
		task_rq_unlock();   // Re-enables interrupts
	}
</code></pre></div></div>
<p>Assume that the <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> needs to de-boost the task’s priority. This
may cause it to enter the scheduler and cause a deadlock due to recursive
locking of RQ/PI locks.</p>

<p>Because of these kind of issues, there has traditionally been a rule that RCU
usage in the scheduler must follow:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>“Thou shall not hold RQ/PI locks across an rcu_read_unlock() if thou not
holding it or disabling IRQ across both both the rcu_read_lock() +
rcu_read_unlock().”
</code></pre></div></div>
<p>More on this rule can be read <a href="https://lwn.net/Articles/453002/">here as well</a>.</p>

<p>Obviously, acquiring RQ/PI locks across the whole <code class="language-plaintext highlighter-rouge">rcu_read_lock()</code> and
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> pair would resolve the above situation. Since preemption
and interrupts are disabled across the whole <code class="language-plaintext highlighter-rouge">rcu_read_lock()</code> and
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> pair; there is no question of task preemption.</p>

<p>Anyway, the point is <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> needs to be careful about scheduler
wake-ups; either by avoiding calls to <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> altogether
(as is the case if interrupts are disabled across the entire RCU reader), or by
detecting situations where a wake up is unsafe. Peter Ziljstra says there’s no
way to know when the scheduler uses RCU, so “generic” detection of the unsafe
condition is a bit tricky.</p>

<p>Now with RCU consolidation, the above situation actually improves. Even if the
scheduler RQ/PI locks are not held across the whole read-side critical sectoin,
but just across that of the <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code>, then that itself may be enough
to prevent a scheduler deadlock. The reasoning is: during the
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code>, we cannot yet report a QS until the RQ/PI lock is itself
released since the act of holding the lock itself means preemption is disabled
and that would cause a QS deferral. As a result, the act of priority
de-boosting would also be deferred and prevent a possible scheduler deadlock.</p>

<p>However, RCU consolidation introduces even newer scenarios where the
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code>  has to enter the scheduler, if the “scheduler rules” above
is not honored, as explained below:</p>

<p>Consider the previous code example. Now also assume that the RCU reader is
blocking an expedited RCU grace period. That is just a fancy term for a grace
period that needs to end fast. These grace periods have to complete much more
quickly than normal grace period. An expedited grace period causes currently
running RCU reader sections to receive IPIs that <a href="https://github.com/joelagnel/linux-kernel/blob/rcu/rcu-check-unsafe-scheduler-use-2/kernel/rcu/tree_exp.h#L641">set a
hint</a>.
Setting of this hint results in the outermost <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> calling
<code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code>, which otherwise would not occur.
When <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> gets called in this scenario, it tries to get
more aggressive once it <a href="https://github.com/joelagnel/linux-kernel/blob/rcu/rcu-check-unsafe-scheduler-use-2/kernel/rcu/tree_plugin.h#L627">notices
that</a>
the reader has blocked an expedited RCU grace period. In particular, it
<a href="https://github.com/joelagnel/linux-kernel/blob/rcu/rcu-check-unsafe-scheduler-use-2/kernel/rcu/tree_plugin.h#L620">notices that preemption is
disabled</a>
and so the grace period cannot end due to RCU consolidation. Out of
desperation, it raises a softirq (<code class="language-plaintext highlighter-rouge">raise_softirq()</code>) in the hope that the next
time the softirq runs, the grace period could be ended quickly before the
scheduler tick occurs. But that can cause a scheduler deadlock by way of entry
into the scheduler due to a ksoftirqd-wakeup.</p>

<p>The cure for this problem is the same, holding the RQ/PI locks across the
entire reader section results in no question of a scheduler related deadlock
due to recursively acquiring of these locks; because there would be no question
of expedited-grace-period IPIs, hence no question of setting of any hints, and
hence no question of calling <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> from scheduler code.
For a twist of the IPI problem, see <a href="#special-note">special note</a>.</p>

<p>However, the RCU consolidation throws yet another curve ball. Paul McKenney
<a href="https://lore.kernel.org/lkml/20190627173831.GW26519@linux.ibm.com/">explained on
LKML</a> that
there is yet another situation now due to RCU consolidation that can cause
scheduler deadlocks.</p>

<p>Consider the following code, where <code class="language-plaintext highlighter-rouge">previous_reader()</code> and <code class="language-plaintext highlighter-rouge">current_reader()</code>
execute in quick succession in the context of the same task:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       previous_reader()
	{
		rcu_read_lock();
		do_something();      // Preemption or IPI happened
		local_irq_disable(); // Cannot be the scheduler
		do_something_else();
		rcu_read_unlock();  // As IRQs are off, defer QS report
                                    //but set deferred_qs bit in 
                                    //rcu_read_unlock_special
		do_some_other_thing();
		local_irq_enable();
	}

        // QS from previous_reader() is still deferred.
	current_reader() 
	{
		local_irq_disable();  // Might be the scheduler.
		do_whatever();
		rcu_read_lock();
		do_whatever_else();
		rcu_read_unlock();    // Must still defer reporting QS
		do_whatever_comes_to_mind();
		local_irq_enable();
	}
</code></pre></div></div>
<p>Here <code class="language-plaintext highlighter-rouge">previous_reader()</code> had a preemption; even though the <code class="language-plaintext highlighter-rouge">current_reader()</code>
did not - but the <code class="language-plaintext highlighter-rouge">current_reader()</code> still needs to call
<code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> from the scheduler!  This situation would not
happen in the pre-consolidated-RCU world because <code class="language-plaintext highlighter-rouge">previous_reader()</code>’s
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> would have taken care of it.</p>

<p>As you can see, just following the scheduler rule of disabling interrupts
across the entire reader section does not help. To detect the above scenario; a
new bitfield  <code class="language-plaintext highlighter-rouge">deferred_qs</code> has been
<a href="https://lore.kernel.org/patchwork/patch/1057344/">added</a> to the
<code class="language-plaintext highlighter-rouge">task_struct::rcu_read_unlock_special</code> union. Now what happens is, at
<code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code>-time, the <code class="language-plaintext highlighter-rouge">previous reader()</code> sets this bit, and the
<code class="language-plaintext highlighter-rouge">current_reader()</code> checks this bit. If set, the call to <code class="language-plaintext highlighter-rouge">raise_softirq()</code> is
avoided thus eliminating the possibility of a scheduler deadlock.</p>

<p>Hopefully no other scheduler deadlock issue is lurking!</p>

<p>Coming back to the scheduler rule, I have been running overnight rcutorture
tests to detect if this rule is ever violated. Here is the <a href="https://github.com/joelagnel/linux-kernel/commits/rcu/rcu-check-unsafe-scheduler-use-2">test
patch</a>
checking for the unsafe condition. So far I have not seen this condition occur
which is a good sign.</p>

<p>I may need to check with Paul McKenney about whether proposing this checking
for mainline is worth it. Thankfully, LPC 2019 is right around the corner! ;-)
——–</p>
<h4 id="special-note">Special Note</h4>
<p>[1] The expedited IPI interrupting an RCU reader has a variation. For an
example see below where the IPI was not received, but we still have a problem
because the <code class="language-plaintext highlighter-rouge">-&gt;need_qs</code> bit in the <code class="language-plaintext highlighter-rouge">rcu_read_unlock_special union</code> got set even
though the expedited grace period started after IRQs were disabled. The start
of the expedited grace period would set the <code class="language-plaintext highlighter-rouge">rnp-&gt;expmask</code> bit for the CPU. In
the unlock path, because the <code class="language-plaintext highlighter-rouge">-&gt;need_qs</code> bit is set, it will call
<code class="language-plaintext highlighter-rouge">rcu_read_unlock_special()</code> and risk a deadlock by way of a <code class="language-plaintext highlighter-rouge">ksoftirqd</code> wakeup
because <code class="language-plaintext highlighter-rouge">exp</code> in that function is true.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU 0                         CPU 1
preempt_disable();
rcu_read_lock();

// do something real long

// Scheduler-tick sets
// -&gt;need_qs as reader is
// held for too long.

local_irq_disable();
                              // Expedited GP started
// Exp IPI not received
// because IRQs are off.

local_irq_enable();

// Here rcu_read_unlock will
// still call ..._special()
// as -&gt;need_qs got set.
rcu_read_unlock();

preempt_enable();
</code></pre></div></div>
<p>The fix for this issue is the same as described earlier, disabling interrupts
across both <code class="language-plaintext highlighter-rouge">rcu_read_lock()</code> and <code class="language-plaintext highlighter-rouge">rcu_read_unlock()</code> in the scheduler path.</p>
</div>
  
  


    </article>



<div class="pagination">
  
    <a href="/page5">&laquo; Previous Post</a> &nbsp; &nbsp; &nbsp;
  

  <!-- Don't want numbers.
  
    
      <a href="/">1</a>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <a href="/page5">5</a>
    
  
    
      <em>6</em>
    
  
    
      <a href="/page7">7</a>
    
  
    
      <a href="/page8">8</a>
    
  
    
      <a href="/page9">9</a>
    
  
    
      <a href="/page10">10</a>
    
  
    
      <a href="/page11">11</a>
    
  
    
      <a href="/page12">12</a>
    
  
    
      <a href="/page13">13</a>
    
  
    
      <a href="/page14">14</a>
    
  
    
      <a href="/page15">15</a>
    
  
    
      <a href="/page16">16</a>
    
  
    
      <a href="/page17">17</a>
    
  
    
      <a href="/page18">18</a>
    
  
    
      <a href="/page19">19</a>
    
  
    
      <a href="/page20">20</a>
    
  
  -->

  
    <a href="/page7">Next Post&raquo;</a>
  
</div>


<!-- div blog-index -->
</div>


<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

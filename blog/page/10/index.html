
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and I run this site! I work in the Android kernel team at Google. My interests are scheduler, tracing, synchronization and kerne...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
    <h2>My dumping ground for what I've been upto</h2>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <a href="/linuxinternals/">Linux Internals Articles</a><br>
 <a href="/blog/archives/">All blog posts</a><br>
 <a href="/resources">Talks and resources</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=150 width=150>
</div>

<div style="position:absolute; top: 170px" class="hnavtitle">
<a>If you solve world hunger, and make a driver that cures people of cancer, by all means enable it by default.
— Linus Torvalds</a>
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and I run this site! I work in the Android kernel team at Google. My interests are scheduler, tracing, synchronization and kernel internals. I also love contributing to the upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and <a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at: joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p><a href="https://patchwork.kernel.org/project/LKML/list/?submitter=170577">Here’s a list</a> of recent kernel patches I submitted. I got <a href="http://hackaday.com/2014/06/08/the-in-circuit-sd-card-switch/">featured on hackaday</a> and <a href="https://lwn.net/Articles/744522/">have written for LWN</a> as well. <a href="/joel/joel-resume.pdf">Check out my resume</a> and also see a list of past <a href="/resources">talks/presentations</a>.</p>

<p><strong><a href="/linuxinternals/">LinuxInternals.org</a></strong> is a resource I created as a collection of articles and resources exploring Linux kernel and internals topics.</p>


Full list of all posts on this site:

<font face="monospace">
 <li><span>10 May 2018</span> &nbsp; <a href="/linuxinternals%20rcu/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a>  [linuxinternals rcu] </li>
</font>

<font face="monospace">
 <li><span>10 Feb 2018</span> &nbsp; <a href="/linuxinternals/2018/02/10/usdt-notes.html">USDT for reliable Userspace event tracing</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>08 Jan 2018</span> &nbsp; <a href="/linuxinternals/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>31 Dec 2016</span> &nbsp; <a href="/linuxinternals/2016/12/31/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>18 Jun 2016</span> &nbsp; <a href="/linuxinternals/2016/06/18/ftrace-events-mechanism.html">Ftrace events mechanism</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>20 Mar 2016</span> &nbsp; <a href="/linuxinternals/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>25 Dec 2015</span> &nbsp; <a href="/electronics,linuxinternals/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a>  [electronics,linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>04 Jun 2014</span> &nbsp; <a href="/linuxinternals/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>07 May 2014</span> &nbsp; <a href="/linuxinternals/2014/05/07/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>24 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>22 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/22/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a>  [linuxinternals] </li>
</font>

</article>

  
  
  
    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/linuxinternals%20rcu/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a></h1>
    
    
      <p class="meta">
        









<time datetime="2018-05-10T00:00:00-07:00" pubdate data-updated="true">May 10, 2018</time>
        
           | <a href="/linuxinternals%20rcu/2018/05/10/5-rcu-preempt-context-switch.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/linuxinternals%20rcu/2018/05/10/5-rcu-preempt-context-switch.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Note: This article requires knowledge of RCU (read copy update) basics and its
different flavors.</p>

<p>RCU’s main algorithm is to detect when it is free to reclaim objects that RCU
readers no longer need. The “RCU-sched” flavor of RCU does this by just
disabling preemption across the read section. So any time any of the CPUs is
not running in a preempt disabled section (such as with preemption off, or
interrupts off), then the CPU is said to be in a “quiescent state” (QS). Once
all CPUs reach a QS after the reclaimer filed a claim to release an object, the
object can be safely released. The time from when the request for RCU to
release an object to when RCU says its Ok to release it, is called the grace
period.</p>

<p>RCU-sched is kind of a big hammer, having readers disable preemption can have
poor performance effects. After all, read sections are expected to be light in
RCU. It can also effect real-time response of applications.</p>

<p>For this reason, preemptible RCU came about (also called RCU-preempt).
Obviously in this flavor, RCU reader sections can get preempted to run
something else.</p>

<p>A <a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1682346.html">recent discussion</a>
on LKML clarified to me that “preempted to run something else” not only covers
involuntary preemption but also voluntarily sleeping. This design is because,
with <code class="highlighter-rouge">PREEMPT_RT</code> kernels, “rt” version of spinlocks are actually mutexes that
can put the RCU reader to sleep.</p>

<p>So coming back to the point of this article, I want to go over what happens on
a context-switch. When the scheduler is called, we end up in <code class="highlighter-rouge">__schedule</code>
function. Here in the beginning <code class="highlighter-rouge">rcu_note_context_switch</code> is called with the
<code class="highlighter-rouge">preempt</code> parameter. The <code class="highlighter-rouge">preempt</code> parameter indicates if task blocked with
help of <code class="highlighter-rouge">schedule()</code> or if it was a kernel path (such as return from interrupts
or system calls) that called into the scheduler to preempt the currently
running task.</p>

<p><code class="highlighter-rouge">rcu_note_context_switch</code> first calls <code class="highlighter-rouge">rcu_preempt_note_context_switch</code> for
RCU-preempt to take note. Lets discuss this function.</p>

<p>First note that the RCU-preempt flavor does warn you if you voluntarily sleep inside
an RCU read side section. I’m not sure how the “RT-spinlock” for RT kernels
doesn’t get this warning. Probably they delete this warning in PREEMPT_RT
patchset, idk. The warning is <code class="highlighter-rouge">WARN_ON_ONCE(!preempt &amp;&amp;
t-&gt;rcu_read_lock_nesting &gt; 0);</code>. But seems pretty clear to me a non-RT kernel
would scream with this warning if an RCU-preempt read section went to sleep.
Getting preempted is Ok but not voluntary sleeping according to this code! (see
side note in last para)</p>

<p>If the task being preempted is in a read-side RCU section, then (and only then)
it calls <code class="highlighter-rouge">rcu_preempt_ctxt_queue</code>. Here the task being preempted is added to a
list of blocked tasks. The reason why we need to add it is, RCU-preempt has 2
perspectives of Quiescent state (QS). Recall, a QS is reached whenever an
entity is not blocking the current grace period (GP). RCU-preempt considers 2
entity perspectives: Either the task, or the CPU. In the RCU-preempt world, if
a task that is currently in an RCU read section gets preempted, then the CPU
has reached a QS because it is no longer running the RCU-read section that is
blocking the GP. But now, the task has reached a non-QS (It is blocking the
GP). This list basically indicates this fact. If there are blocking tasks, then
the GP cannot complete even though the CPU reports its QS. <a href="https://lkml.org/lkml/2018/5/4/632">Paul Mckenney explains this here</a>. The other benefit of having a list of tasks is that preempted RCU read sections can be boosted. Paul Mckenney again came to the rescue to <a href="https://lkml.org/lkml/2018/5/4/659">explain this to me</a>.</p>

<p>Finally, you see that <code class="highlighter-rouge">rcu_preempt_note_context_switch</code> does report a QS. This
is because if the task was in a read section, it has just been added to the
blocked task list. If its not, then we just reached a QS for the CPU. Either
way we entered a CPU QS. So is recorded with a call to <code class="highlighter-rouge">rcu_preempt_qs();</code>.</p>

<p>Please go through the <a href="https://www.kernel.org/doc/Documentation/RCU/Design/Expedited-Grace-Periods/Expedited-Grace-Periods.html">Expedited GP document</a> which also explains some of the RCU-preempt behaviors.</p>

<p>Side note: At the moment, I don’t immediately see why by blocking in a RCU-preempt
section shouldn’t be allowed.  Since we’re tracking blocked tasks the same way
as preempted tasks, it should be possible to handle them the same way. They
both cause a CPU QS and a task non-QS to be entered, they both need priority
boosting. Perhaps the warning should be removed? Let me know your feedback in
the comments.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

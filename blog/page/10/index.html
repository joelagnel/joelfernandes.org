
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchroniz...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchronization,
memory models and other kernel internals. I also love contributing to the
upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and
<a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at:
joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p>Look for my name in the kernel git log to find my upstream kernel patches.
Check out <a href="/joel/joel-resume.pdf">my resume</a> for full details of my work
experience. I also actively present at conferences, see a list of my past
<a href="/resources">talks, presentations and publications</a>.</p>

Full list of all blog posts on this site:

<font face="monospace">
 <li>
   <span>28 Apr 2023</span> &nbsp; <a href="/rcu/synchronization/2023/04/28/hazard-pointers.html">Understanding Hazard Pointers</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2023</span> &nbsp; <a href="/kernel/stack/2023/04/25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [kernelstack]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Feb 2023</span> &nbsp; <a href="/vim/productivity/2023/02/24/ycm-working.html">Getting YouCompleteMe working for kernel development</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [vimproductivity]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>29 Jan 2023</span> &nbsp; <a href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html">Figuring out herd7 memory models</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [herd7lkmmformalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>13 Nov 2022</span> &nbsp; <a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [timerslinuxkernel]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Oct 2020</span> &nbsp; <a href="/c++/2020/10/25/cpp-ref.html">C++ rvalue references</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [c++]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>06 Mar 2020</span> &nbsp; <a href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html">SRCU state double scan</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusrcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>18 Oct 2019</span> &nbsp; <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [pluscaltla+formalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>02 Sep 2019</span> &nbsp; <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcuschedulerlocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/23/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxinternals]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>15 Jun 2018</span> &nbsp; <a href="/linux/kernel/rcu/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcu]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2018</span> &nbsp; <a href="/linux/kernel/debugging/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneldebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 May 2018</span> &nbsp; <a href="/linux/kernel/rcu/scheduler/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcuscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>11 Feb 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 Jan 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>01 Jan 2017</span> &nbsp; <a href="/linux/kernel/tracing/armv8/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracingarmv8]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>19 Jun 2016</span> &nbsp; <a href="/linux/kernel/tracing/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>20 Mar 2016</span> &nbsp; <a href="/linux/kernel/scheduler/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Dec 2015</span> &nbsp; <a href="/electronics/embedded/linux/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [electronicsembeddedlinux]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>04 Jun 2014</span> &nbsp; <a href="/linux/embedded/electronics/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxembeddedelectronics]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 May 2014</span> &nbsp; <a href="/linux/kernel/locking/2014/05/08/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernellocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2014</span> &nbsp; <a href="/synchronization/2014/04/25/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [synchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Apr 2014</span> &nbsp; <a href="/linux/kernel/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernel]

     !-->
 </li>
</font>

</article>


 <!-- This loops through the paginated posts -->




    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/rcu/synchronization/2023/04/28/hazard-pointers.html">Understanding Hazard Pointers</a></h1>
    
    
      <p class="meta">
        









<time datetime="2023-04-28T00:00:00+00:00" pubdate data-updated="true">Apr 28, 2023</time>
        
           | <a href="/rcu/synchronization/2023/04/28/hazard-pointers.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/rcu/synchronization/2023/04/28/hazard-pointers.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1 id="introduction"><strong>Introduction</strong></h1>

<p>In concurrent systems, managing concurrent access to shared memory resources
efficiently and safely is of paramount importance. Hazard pointers, like RCU,
is a synchronization mechanism that can be used to address this issue. In this
post, we will explore how hazard pointers work, provide a simple example to
illustrate their usage, and compare them with another popular synchronization
technique called Read-Copy-Update (RCU). Additionally, we will dive into the
implementation details of hazard pointers, including the per-CPU and per-thread
data structures used to maintain them.</p>

<h2 id="example-with-a-singly-linked-list"><strong>Example with a Singly Linked List</strong></h2>

<p>Consider a singly linked list that is shared among multiple threads. In this example, some threads may be traversing the list while others may be adding or removing nodes. The main challenge here is to ensure that a node being accessed by a reader is not deleted or modified by a writer simultaneously.</p>

<p>Hazard pointers provide a mechanism to temporarily “protect” a node while it is being accessed. When a thread wants to access a node, it stores the address of the node in a hazard pointer, signaling that the node is in use. Before a writer can remove or modify a node, it must check all hazard pointers to ensure that the node is not currently being accessed by any other thread.</p>

<p>Here’s a step-by-step illustration of how hazard pointers work:</p>

<ol>
  <li>Thread A starts traversing the list and wants to access node B.</li>
  <li>Thread A stores the address of node B in a hazard pointer, marking it as “in use.”</li>
  <li>Thread B attempts to remove node B from the list but first checks all hazard pointers.</li>
  <li>Thread B sees that node B is in use by Thread A (due to the hazard pointer) and must wait before removing it.</li>
  <li>Thread A finishes accessing node B and clears its hazard pointer.</li>
  <li>Thread B can now safely remove node B from the list.</li>
</ol>

<h2 id="a-reader-traversing-a-list-may-need-to-retry">A reader traversing a list may need to retry</h2>

<p>This can happen if the reader steps on a list element that was freed. Let’s go through a simple example step by step to see why this might happen:</p>

<p>Imagine a singly-linked list with three elements: A, B, and C. We have two threads, Thread 0 and Thread 1, which read and modify the list concurrently.</p>

<ol>
  <li>Thread 0 wants to read element B. To do this safely, it first records a hazard pointer to element B, indicating that it is about to access B and that B should not be deleted while Thread 0 is using it.</li>
  <li>Thread 1 wants to delete element B from the list. It removes B from the list by updating A’s next pointer to point to C instead of B. Thread 1 checks for hazard pointers referencing B and sees that Thread 0 has a hazard pointer to B. Since Thread 0 is still using B, Thread 1 cannot delete it yet.</li>
  <li>Thread 1 now wants to delete element C. It removes C from the list by updating B’s next pointer to be a special value called <code class="language-plaintext highlighter-rouge">HAZPTR_POISON</code>, marking the deletion. Since no hazard pointers reference C, Thread 1 can immediately delete C.</li>
  <li>Thread 0 finishes reading element B and moves on to the next element in the list. It tries to acquire a hazard pointer for B’s successor, which is now marked as <code class="language-plaintext highlighter-rouge">HAZPTR_POISON</code> due to the deletion of element C. When Thread 0 encounters the <code class="language-plaintext highlighter-rouge">HAZPTR_POISON</code> value, it knows that the list has been modified concurrently and must restart its traversal from the beginning of the list.</li>
  <li>Thread 0 starts over, traversing the list again from the beginning. This time, it finds the updated list without elements B and C.</li>
  <li>Once Thread 0 is done using element B and releases its hazard pointer, Thread 1 is free to delete B as there are no longer any hazard pointers referencing it.</li>
</ol>

<h2 id="comparing-hazard-pointers-with-rcu"><strong>Comparing Hazard Pointers with RCU</strong></h2>

<p>Both hazard pointers and RCU are synchronization mechanisms that allow for efficient handling of shared resources. However, they differ in several key aspects:</p>

<ol>
  <li>Read-side performance: RCU typically offers better read-side performance than hazard pointers, as it does not require retries. Hazard pointers, on the other hand, may involve read-side retries due to concurrent modifications, which can slow down the read-side performance.</li>
  <li>Write-side performance: While hazard pointers generally provide better write-side performance than naive reference counting, they may still be slower than RCU. This is because hazard pointers require writers to check all hazard pointers before modifying an object, which can be time-consuming when there are many of them. Furthermore, traversal of per-thread data structures to scan for hazard pointers may result in cache contention when there are lots of readers storing hazard pointers.</li>
  <li>Memory footprint: Hazard pointers have a minimal memory footprint, as any object not currently protected by a hazard pointer can be immediately freed. RCU, on the other hand, may require a larger memory footprint due to its deferred reclamation mechanism.</li>
  <li>Data structure size: Hazard pointers don’t require any additional members in the objects their pointing to. In contract, RCU typically requires an rcu_head structure representing it, and traditional reference counting mechanisms require an integer. This makes Hazard Pointers really useful for objects of small size.</li>
  <li>Grace period: RCU requires a grace period even when there are no readers, which can cause latency issues. With hazard pointers, objects can be freed instantly as soon as they are no longer being used by any thread.</li>
  <li>Reclamation of memory: Hazard pointers allow for the immediate reclamation of any object not currently protected by a hazard pointer. This means that hazard pointers can be freed per-object while not freeing others. However, with RCU, reclamation is independent of specific objects and may require a larger memory footprint due to its deferred reclamation mechanism.</li>
</ol>

<h2 id="implementation-of-hazard-pointers"><strong>Implementation of Hazard Pointers</strong></h2>

<p>Hazard pointers are maintained in per-CPU or per-thread data structures. This design choice allows for improved cache locality, as each thread or CPU only needs to update its own local data structure when accessing shared resources. Consequently, this reduces contention and cache coherency traffic, leading to good read-side performance. However, the write-side performance of hazard pointers may be slower than RCU, as writers need to check all hazard pointers before modifying an object. This can be time-consuming when there are many hazard pointers to check. Furthermore, traversal of per-thread data structures to scan for hazard pointers may result in cache contention when there are many readers storing hazard pointers, leading to additional overhead.</p>

<h2 id="virtual-reference-counting-using-hazard-pointers">Virtual Reference Counting using Hazard Pointers</h2>

<p>Virtual reference counting is a technique used to avoid the overhead of maintaining reference counts for each object in a concurrent system. Instead of incrementing and decrementing object reference counts, threads maintain a list of “virtual” reference counts in the form of hazard pointers.</p>

<p>When a thread wants to access an object, it temporarily protects the object using a hazard pointer. This marks the object as “in use” and guarantees that it won’t be freed or modified by any other thread. By counting the number of hazard pointers in the system, it is possible to determine the “value of the virtual refcount.” The absence of hazard pointers implies that the number of references to an object is zero, which means that the object can be destroyed.</p>

<p>Virtual reference counting eliminates the need to maintain reference counts for each object resulting in the object saving space as a separate refcount need to be stored in the object. This is very useful for small objects.</p>

<h2 id="in-summary">In summary</h2>

<p>Hazard pointers could be an effective synchronization mechanism for managing
shared access to objects in concurrent systems. They offer good read-side
performance and may offer better memory footprint than RCU due to smaller data
structure footprint and quicker memory reclaim. However, they have poor
read-side performance and complexity, compared to RCU. On modern systems with
ever increasing amounts of memory, RCU makes much more sense to use than HP.</p>
</div>
  
  


    </article>



<div class="pagination">
  

  <!-- Don't want numbers.
  
    
      <em>1</em>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <a href="/page5">5</a>
    
  
    
      <a href="/page6">6</a>
    
  
    
      <a href="/page7">7</a>
    
  
    
      <a href="/page8">8</a>
    
  
    
      <a href="/page9">9</a>
    
  
    
      <a href="/page10">10</a>
    
  
    
      <a href="/page11">11</a>
    
  
    
      <a href="/page12">12</a>
    
  
    
      <a href="/page13">13</a>
    
  
    
      <a href="/page14">14</a>
    
  
    
      <a href="/page15">15</a>
    
  
    
      <a href="/page16">16</a>
    
  
    
      <a href="/page17">17</a>
    
  
    
      <a href="/page18">18</a>
    
  
    
      <a href="/page19">19</a>
    
  
    
      <a href="/page20">20</a>
    
  
    
      <a href="/page21">21</a>
    
  
    
      <a href="/page22">22</a>
    
  
    
      <a href="/page23">23</a>
    
  
  -->

  
    <a href="/page2">Next Post&raquo;</a>
  
</div>


<!-- div blog-index -->
</div>


<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>

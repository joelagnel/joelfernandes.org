
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! I’m Joel and I run this site! I work at Google. My interests are scheduler, tracing, synchronization and kernel internals. I also love co...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
    <h2>My dumping ground for what I've been upto</h2>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <a href="/linuxinternals/">Linux Internals Articles</a><br>
 <a href="/blog/archives/">All blog posts</a><br>
 <a href="/resources">Talks and resources</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! I’m Joel and I run this site! I work at Google. My interests are scheduler, tracing, synchronization and kernel internals. I also love contributing to the upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and <a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at: joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p><a href="https://patchwork.kernel.org/project/LKML/list/?submitter=170577">Here’s a list</a> of recent kernel patches I submitted. I got <a href="http://hackaday.com/2014/06/08/the-in-circuit-sd-card-switch/">featured on hackaday</a> and <a href="https://lwn.net/Articles/744522/">have written for LWN</a> as well. <a href="/joel/joel-resume.pdf">Check out my resume</a> and also see a list of past <a href="/resources">talks/presentations</a>.</p>

<p><strong><a href="/linuxinternals/">LinuxInternals.org</a></strong> is a resource I created as a collection of articles and resources exploring Linux kernel and internals topics.</p>


Full list of all posts on this site:

<font face="monospace">
 <li><span>29 Jan 2023</span> &nbsp; <a href="/herd7/2023/01/29/figuring-out-herd7.html">Figuring out herd7 models</a>  [herd7] </li>
</font>

<font face="monospace">
 <li><span>23 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/23/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>15 Jun 2018</span> &nbsp; <a href="/linuxinternals/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>10 Jun 2018</span> &nbsp; <a href="/linux/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a>  [linux] </li>
</font>

<font face="monospace">
 <li><span>10 May 2018</span> &nbsp; <a href="/linuxinternals/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>11 Feb 2018</span> &nbsp; <a href="/linuxinternals/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>08 Jan 2018</span> &nbsp; <a href="/linuxinternals/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>01 Jan 2017</span> &nbsp; <a href="/linuxinternals/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>19 Jun 2016</span> &nbsp; <a href="/linuxinternals/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>20 Mar 2016</span> &nbsp; <a href="/linuxinternals/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>25 Dec 2015</span> &nbsp; <a href="/electronics,linuxinternals/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a>  [electronics,linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>04 Jun 2014</span> &nbsp; <a href="/linuxinternals/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>08 May 2014</span> &nbsp; <a href="/linuxinternals/2014/05/08/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>25 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/25/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a>  [linuxinternals] </li>
</font>

<font face="monospace">
 <li><span>23 Apr 2014</span> &nbsp; <a href="/linuxinternals/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a>  [linuxinternals] </li>
</font>

</article>

  
  
  
    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/herd7/2023/01/29/figuring-out-herd7.html">Figuring out herd7 models</a></h1>
    
    
      <p class="meta">
        









<time datetime="2023-01-29T00:00:00+00:00" pubdate data-updated="true">Jan 29, 2023</time>
        
           | <a href="/herd7/2023/01/29/figuring-out-herd7.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/herd7/2023/01/29/figuring-out-herd7.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[Article is under construction]</p>

<p>The herd7 memory consistency tool is used to verify if certain (mostly
undesirable) outcomes (memory-related) of concurrent programs exist, given a
memory model. A memory-model restricts possible candidate executions. After
such restriction, if certain undesirable still exist, the user is notified
via their assertions in the <code class="language-plaintext highlighter-rouge">exists</code> clause of a litmus test.</p>

<p>This is an advanced article that goes through the different parts of the
linux-kernel.cat code, and tries to explain with examples about how/why
properties are defined the way they are. The motivation to understand this
deeply is, by understanding how to read a memory model written in CAT, it
should be possible to get a deep understanding of how memory consistency and
ordering works and how a memory model behaves. Even though the herd7 memory
model is abstract in some sense (it does not describe CPU implementation but
just a set of properites and rules on memory ordering and program execution),
it can still be considered to model of how a CPU should behave. Thus it can be
argued that you are formally defining how memory accesses in CPUs should
typically behave, if such CPUs are expected to run concurrent Linux kernel
code.</p>

<p>It is assumed that the reader is already familiar with how to use the tool, as
well is familiar with various notations such as <code class="language-plaintext highlighter-rouge">-&gt;po</code>, <code class="language-plaintext highlighter-rouge">-&gt;co</code> etc. This is
described in much detail in the
<code class="language-plaintext highlighter-rouge">tools/memory-model/Documentation/explanation.txt</code>. There are also several LWN
articles and conference papers on the herd7 tools which we will not replicate
here.</p>

<ol>
  <li>Sequential consistency per-variable (SCPV)</li>
</ol>

<p>This property is fundamental in modern processors, and it basically means that
reads and writes to a certain variable happen in a total-order. In other words,
for a specific variable, it is not possible to observe a sequence of writes to
that variable in an order different from the order in which its values were
written.</p>

<p>This also applies to the writes happening on the same CPU. In a single CPU, the
writes happenning on the same variable happen in program order execution.</p>

<p>The way the memory model can enforce this is by defining a rule forbidding a
certain property. Let us see if we can define the violations of SCPV as a cycle
in a particular candidate execution, and then tell the model that such execution
candidates are forbidden.</p>

<p>Consider a program doing 2 writes to a variable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P0(int *x) {
  WRITE_ONCE(*x, 2);            // event W1
  WRITE_ONCE(*x, 3);            // event W2
}
</code></pre></div></div>

<p>Without <code class="language-plaintext highlighter-rouge">SCPV</code>, this program has 2 outcomes:</p>

<ol>
  <li>The final value of x is 2. This happens because of the following candidate execution:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W2 -&gt;co W1
</code></pre></div></div>

<ol>
  <li>The final value of x is 3. This happens because of the following candidate execution:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W1 -&gt;co W2
</code></pre></div></div>

<p>We wish to forbid the pattern in #1. How do we do that?</p>

<p>Observe that because of program ordering, there is a relation: <code class="language-plaintext highlighter-rouge">W1 -&gt; W2</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">-&gt;po-loc</code> relation links to program-ordered memory accesses happening on
the same CPU.</p>

<p>We can combine program ordering (<code class="language-plaintext highlighter-rouge">-&gt;po-loc</code>) and cache coherent ordering
(<code class="language-plaintext highlighter-rouge">-&gt;co</code>) to build a cycle. We can build a new relation by taking the union of
the 2:
<code class="language-plaintext highlighter-rouge">po-loc | co</code>
This relation becomes <code class="language-plaintext highlighter-rouge">W1 -&gt; po-loc -&gt; W2 -&gt; co -&gt; W1</code> for case #1 or in other
words, a cycle. So we can say <code class="language-plaintext highlighter-rouge">acyclic po-loc | co</code> to forbid the bad candidate
execution.</p>

<p>Another possibility is, there are writes happening on different CPUs:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P0(int *x) {
  WRITE_ONCE(*x, 2);            // event W1
  WRITE_ONCE(*x, 3);            // event W2
}

P1(int *x) {
  WRITE_ONCE(*x, 4);            // event W3
}
</code></pre></div></div>

<p>Here there are 6 possible candidate executions:</p>

<p>1.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W1-&gt;W2-&gt;W3
</code></pre></div></div>
<p>Final value is 4.</p>

<p>2.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W2-&gt;W1-&gt;W3
</code></pre></div></div>
<p>Final value is 4.</p>

<p>3.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W2-&gt;W3-&gt;W1
</code></pre></div></div>
<p>Final value is 2.</p>

<p>4.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W1-&gt;W3-&gt;W2
</code></pre></div></div>
<p>Final value is 3.</p>

<p>5.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W3-&gt;W1-&gt;W2
</code></pre></div></div>
<p>Final value is 3.</p>

<p>6.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W3-&gt;W2-&gt;W1
</code></pre></div></div>
<p>Final value is 2.</p>

<p>Here cases #3 and #6 should be forbidden. The only allowed outcomes should be 3 or 4.</p>

<p>#3 has the following relations:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W2 -&gt;co W3
W3 -&gt;co W1
W1 -&gt;po-loc W2
</code></pre></div></div>
<p>A cycle can be observed when uniting all of these relations using <code class="language-plaintext highlighter-rouge">po-loc | co</code></p>

<p>Thus <code class="language-plaintext highlighter-rouge">acyclic po-loc | co</code> can again be used to forbid the candidate executions #3, and similarly #6.</p>

<p>So far we have only considered stores, however we must order the reads from
these stores as well, and such reads cannot observe the stores to the same
variable out of order. Let us next look at an example, where the above
acyclic definition is incomplete.</p>

<p>Consider the following Litmus test involving read accesses:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C scpv-rf

{}

P0(int *x)
{
        WRITE_ONCE(*x, 2);
        WRITE_ONCE(*x, 3);
}

P1(int *x)
{
        int r1;
        int r2;

        r1 = READ_ONCE(*x);
        r2 = READ_ONCE(*x);
}

exists (1:r1=3 /\ 1:r2=2)
</code></pre></div></div>

<p>Here, we hope that the reads to variable <code class="language-plaintext highlighter-rouge">x</code> are observed by P1 in the
program-order that were written in P0. So the forbidden exists clause should
never occur.</p>

<p>However, if you were to build a CAT model as follows, using the previously
determined acyclic property, then the forbidden case indeed happens.</p>

<p>Here is the CAT code:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include "cos.cat"

acyclic po-loc | co
</code></pre></div></div>

<p>This can be run using herd7 as follows, with the <code class="language-plaintext highlighter-rouge">-show prop</code> options to generate a DOT graph file of the forbidden case:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>herd7 -bell linux-kernel.bell -macros linux-kernel.def -cat test.cat scpvrf.litmus -show prop -o OUT/
</code></pre></div></div>

<p>Running this shows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test scpv-rf Allowed
States 9
1:r1=0; 1:r2=0;
1:r1=0; 1:r2=2;
1:r1=0; 1:r2=3;
1:r1=2; 1:r2=0;
1:r1=2; 1:r2=2;
1:r1=2; 1:r2=3;
1:r1=3; 1:r2=0;
1:r1=3; 1:r2=2;
1:r1=3; 1:r2=3;
Ok
Witnesses
Positive: 1 Negative: 8
Condition exists (1:r1=3 /\ 1:r2=2)
Observation scpv-rf Sometimes 1 8
Time scpv-rf 0.00
Hash=f2f1ffdc787b0e923ae8cf087fcd5b12
</code></pre></div></div>
<p>And the graph for the forbidden case is as follows:
<img src="/images/herd7/scpv/scpvrf.svg" alt="A graph showing failure of read sequential consistency" /></p>

<p>It is easy to see here that a cycle exists between either <code class="language-plaintext highlighter-rouge">co, rf and fr</code>, or
<code class="language-plaintext highlighter-rouge">po-loc, rf and fr</code>.</p>

<p>This shows that both <code class="language-plaintext highlighter-rouge">-&gt;rf</code> and <code class="language-plaintext highlighter-rouge">-&gt;fr</code> should be included in the acyclic
relation as well. Hence to avoid the problematic candidate execution, the SCPV
property should be <code class="language-plaintext highlighter-rouge">acyclic po-loc | co | rf | fr</code>. That is indeed the case.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JoelFernandes.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="


Hello! Iâ€™m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchroniz...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="JoelFernandes.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-50777115-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50777115-1');
</script>

</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">JoelFernandes.org</a></h1>
  
  <!--
    1/29/2023:
    Changed from h2 to h6 to accomodate longer subtitle.
  -->
    <h6>Age is of no importance unless you're a cheese -- Billie Burke</h6>
  
</div>
<div style="float:left;" class="hnav">
 <br>
 <!--
   a href="/linuxinternals/">Linux Internals Articles</a><br>
 !-->
 <a href="/categories/">Blog posts by category.</a><br>
 <a href="/blog/archives/">Archive of all blog posts.</a><br>
 <a href="/resources">Presentations and other work.</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=100 width=100>
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div class="blog-index">

<article>
<p>Hello! Iâ€™m Joel and this my personal website built with Jekyll! I currently
work at Google. My interests are scheduler, RCU, tracing, synchronization,
memory models and other kernel internals. I also love contributing to the
upstream Linux kernel and other open source projects.</p>

<p>Connect with me on <a href="https://twitter.com/joel_linux">Twitter</a>, and
<a href="https://www.linkedin.com/in/joelagnel">LinkedIn</a>. Or, drop me an email at:
joel <em>at</em> joelfernandes <em>dot</em> org</p>

<p>Look for my name in the kernel git log to find my upstream kernel patches.
Check out <a href="/joel/joel-resume.pdf">my resume</a> for full details of my work
experience. I also actively present at conferences, see a list of my past
<a href="/resources">talks, presentations and publications</a>.</p>

Full list of all blog posts on this site:

<font face="monospace">
 <li>
   <span>25 Apr 2023</span> &nbsp; <a href="/kernel/stack/2023/04/25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [kernelstack]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>24 Feb 2023</span> &nbsp; <a href="/vim/productivity/2023/02/24/ycm-working.html">Getting YouCompleteMe working for kernel development</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [vimproductivity]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>29 Jan 2023</span> &nbsp; <a href="/herd7/lkmm/formalmethods/2023/01/29/figuring-out-herd7.html">Figuring out herd7 memory models</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [herd7lkmmformalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>13 Nov 2022</span> &nbsp; <a href="/timers/linux/kernel/2022/11/13/hrtimer.html">On workings of hrtimer's slack time functionality</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [timerslinuxkernel]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Oct 2020</span> &nbsp; <a href="/c++/2020/10/25/cpp-ref.html">C++ rvalue references</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [c++]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>06 Mar 2020</span> &nbsp; <a href="/rcu/srcu/synchronization/2020/03/06/srcu-scan.html">SRCU state double scan</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcusrcusynchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>18 Oct 2019</span> &nbsp; <a href="/pluscal/tla+/formalmethods/2019/10/18/pluscal-store-ordering.html">Modeling (lack of) store ordering using PlusCal - and a wishlist</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [pluscaltla+formalmethods]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>02 Sep 2019</span> &nbsp; <a href="/rcu/scheduler/locking/2019/09/02/rcu-schedlocks.html">Making sense of scheduler deadlocks in RCU</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [rcuschedulerlocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Dec 2018</span> &nbsp; <a href="/linuxinternals/2018/12/23/stack-dumps.html">Dumping User and Kernel stacks on Kernel events</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxinternals]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>15 Jun 2018</span> &nbsp; <a href="/linux/kernel/rcu/2018/06/15/rcu-dynticks.html">RCU and dynticks-idle mode</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcu]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 Jun 2018</span> &nbsp; <a href="/linux/kernel/debugging/2018/06/10/kernel-gdb.html">Single-stepping the kernel's C code</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneldebugging]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>10 May 2018</span> &nbsp; <a href="/linux/kernel/rcu/scheduler/2018/05/10/5-rcu-preempt-context-switch.html">RCU-preempt: What happens on a context switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelrcuscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>11 Feb 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/02/11/usdt-notes.html">USDT for reliable Userspace event tracing</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 Jan 2018</span> &nbsp; <a href="/linux/kernel/tracing/2018/01/08/bpfd-bcc.html">BPFd- Running BCC tools remotely across systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>01 Jan 2017</span> &nbsp; <a href="/linux/kernel/tracing/armv8/2017/01/01/nmi-perf-armv8.html">ARMv8: flamegraph and NMI support</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracingarmv8]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>19 Jun 2016</span> &nbsp; <a href="/linux/kernel/tracing/2016/06/19/ftrace-events-mechanism.html">Ftrace events mechanism</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkerneltracing]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>20 Mar 2016</span> &nbsp; <a href="/linux/kernel/scheduler/2016/03/20/tif-need-resched-why-is-it-needed.html">TIF_NEED_RESCHED: why is it needed</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernelscheduler]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Dec 2015</span> &nbsp; <a href="/electronics/embedded/linux/2015/12/25/tying-2-voltage-sources-slash-signals-together.html">Tying 2 voltage sources/signals together</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [electronicsembeddedlinux]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>04 Jun 2014</span> &nbsp; <a href="/linux/embedded/electronics/2014/06/04/a-microsd-card-remote-switcher.html">MicroSD card remote switch</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxembeddedelectronics]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>08 May 2014</span> &nbsp; <a href="/linux/kernel/locking/2014/05/08/spinlock-implementation-in-linux-kernel.html">Linux Spinlock Internals</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernellocking]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>25 Apr 2014</span> &nbsp; <a href="/synchronization/2014/04/25/studying-cache-line-sharing-effects-on-smp-systems.html">Studying cache-line sharing effects on SMP systems</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [synchronization]

     !-->
 </li>
</font>

<font face="monospace">
 <li>
   <span>23 Apr 2014</span> &nbsp; <a href="/linux/kernel/2014/04/23/design-of-fork-followed-by-exec-in-linux.html">Design of fork followed by exec in Linux</a> 
   <!--
     Commenting out categories in square brackets, because it does not work
     properly. Check posts/category.html if you want to generate linked
     categories here.

   [linuxkernel]

     !-->
 </li>
</font>

</article>


 <!-- This loops through the paginated posts -->




    <article>
Most Recept Post:
      
  <header>
    
      <h1 class="entry-title"><a href="/kernel/stack/2023/04/25/ppc-stack-guards.html">PowerPC stack guard false positives in Linux kernel</a></h1>
    
    
      <p class="meta">
        









<time datetime="2023-04-25T00:00:00+00:00" pubdate data-updated="true">Apr 25, 2023</time>
        
           | <a href="/kernel/stack/2023/04/25/ppc-stack-guards.html#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org/kernel/stack/2023/04/25/ppc-stack-guards.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, the RCU mailing list
<a href="https://lore.kernel.org/rcu/CAABZP2xVCQhizytn4H9Co7OU3UCSb_qNJaOszOawUFpeo=qpWQ@mail.gmail.com/T/#t">received</a>
a report about an SRCU function failing stack guard checks.</p>

<p>Stack guard canaries are a security mechanism used to detect stack buffer
overflows. This mechanism works by placing a random value, called a canary,
between the local variables and the return address on the stack. If a buffer
overflow occurs, the canary value will be overwritten and the stack guard check
will fail, indicating that the program is being attacked. False positives can
occur if the canary value is overwritten by a legitimate write operation, such
as when a large structure is copied onto the stack.</p>

<p>Closer inspection of the function (<code class="language-plaintext highlighter-rouge">srcu_gp_start_if_needed</code>) did not reveal
any buffers that may be overflowed.</p>

<p>After discussions with a number of kernel developers, it is clear what the
issue is. Firstly, credit to Boqun Feng for looking through disassembly and
pointing things out which led to the whole email chain and discovery of the
issue.</p>

<p>A significant hint came from Christophe who is the kernel author of PPCâ€™s stack
protection, he mentioned:</p>

<aside>
ðŸ’¡ Each task has its own canary, stored in task struct : kernel/fork.c:1012:
tsk-&gt;stack_canary = get_random_canary();
On PPC32 we have register 'r2' that points to task struct at all time, 
so GCC is instructed to find canary at an offset from r2.
But on PPC64 we have no such register.
Instead we have r13 that points to the PACA struct which is a per-cpu
structure, and we have a pointer to 'current' task struct in the PACA struct.
So in order to be able to have the canary as an offset of a fixed register as
expected by GCC, we copy the task canary into the cpu's PACA struct during
_switch():
</aside>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nx">addi</span>	<span class="nx">r6</span><span class="p">,</span><span class="nx">r4</span><span class="p">,</span><span class="o">-</span><span class="nx">THREAD</span>	<span class="cm">/* Convert THREAD to 'current' */</span>
	<span class="nx">std</span>	<span class="nx">r6</span><span class="p">,</span><span class="nx">PACACURRENT</span><span class="p">(</span><span class="nx">r13</span><span class="p">)</span>	<span class="cm">/* Set new 'current' */</span>
  <span class="err">#</span><span class="k">if</span> <span class="nx">defined</span><span class="p">(</span><span class="nx">CONFIG_STACKPROTECTOR</span><span class="p">)</span>
	  <span class="nx">ld</span>	<span class="nx">r6</span><span class="p">,</span> <span class="nx">TASK_CANARY</span><span class="p">(</span><span class="nx">r6</span><span class="p">)</span>
	  <span class="nx">std</span>	<span class="nx">r6</span><span class="p">,</span> <span class="nx">PACA_CANARY</span><span class="p">(</span><span class="nx">r13</span><span class="p">)</span>
  <span class="err">#</span><span class="nx">endif</span>
</code></pre></div></div>

<hr />

<p>In 64-bit PPC, the TLS (Thread Local Storage) cannot be pointed to by register <code class="language-plaintext highlighter-rouge">r2</code> as it is used to store the TOC (Table of Contents) pointer instead, which is used for accessing global and static data. Therefore, the kernel saves the currently running <code class="language-plaintext highlighter-rouge">task_struct</code> in the per-CPU area pointed to by <code class="language-plaintext highlighter-rouge">r13</code> instead. This is known as the Processor Access Control Area (PACA). The PACA is a per-CPU memory area that stores information about the CPUâ€™s context. One of the users of this data structure is to save the current instruction location prior to interrupt processing.</p>

<p>On PPC64, each task has its own stack canary, stored in the task struct. However, unlike PPC32, there is no fixed register that points to the currently running <code class="language-plaintext highlighter-rouge">task_struct</code> at all times. Instead, the per-CPU PACA struct contains a pointer to the current <code class="language-plaintext highlighter-rouge">task_struct</code>. Therefore, in order to be able to have the canary as an offset of a fixed register as expected by GCC, the task canary is copied into the PACA struct during <code class="language-plaintext highlighter-rouge">_switch()</code>. False positives can occur if GCC keeps an old value of the per-CPU struct pointer, which then gets the canary from the wrong CPU struct, leading to a different task.</p>

<p>This issue with storing canaries of the currently running task is related to the issue of not being able to use <code class="language-plaintext highlighter-rouge">r2</code> to point to the TLS on 64-bit PPC. The kernel must use the per-CPU area to store the currently running <code class="language-plaintext highlighter-rouge">task_struct</code>, which leads to the need to copy the task canary into the PACA struct during <code class="language-plaintext highlighter-rouge">_switch()</code>. The compiler optimization that causes the register <code class="language-plaintext highlighter-rouge">r13</code> to be cached into <code class="language-plaintext highlighter-rouge">r10</code> can then lead to false positives if GCC keeps an old value of the per-CPU struct pointer.</p>

<h3 id="so-what-the-heck-is-paca">So what the heck is PACA?</h3>

<p>This <code class="language-plaintext highlighter-rouge">r13</code> register points to a structure in the kernel called PACA which is a per-CPU memory area storing information about the CPUâ€™s context.</p>

<p>Per the PPC64 <a href="https://www.kernel.org/doc/ols/2001/ppc64.pdf">paper</a>:</p>

<p>This structure contains information unique to each processor; therefore an array of PACAs are created, one for each logical processor. One of the users of this data structure to save the current instruction location prior to interrupt processing.</p>

<h3 id="so-whats-up-with-the-canary">So whatâ€™s up with the Canary?</h3>

<p>As explained earlier in the article and as Christpophe answered this for me:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">PPC64</span> <span class="nx">uses</span> <span class="nx">a</span> <span class="nx">per</span><span class="o">-</span><span class="nx">task</span> <span class="nx">canary</span><span class="p">.</span> <span class="nx">But</span> <span class="nx">unlike</span> <span class="nx">PPC32</span><span class="p">,</span> <span class="nx">PPC64</span> <span class="nx">doesn</span><span class="dl">'</span><span class="s1">t have a fixed 
register pointing to </span><span class="dl">'</span><span class="nx">current</span><span class="dl">'</span><span class="s1"> at all time so the canary is copied into 
a per-cpu struct (PACA) during _switch().

If GCC keeps an old value of the per-cpu struct pointer, it then gets 
the canary from the wrong CPU struct so from a different task.
</span></code></pre></div></div>

<h3 id="compiler-optimizations">Compiler optimizations</h3>

<p>What Christophe refers to in the last line is exactly a Compilter optimization. It turns out that from the reporterâ€™s email, the <code class="language-plaintext highlighter-rouge">r10</code> register was used as a base pointer to the per-CPU PACA area. This means the compiler must have cached <code class="language-plaintext highlighter-rouge">r13</code> into <code class="language-plaintext highlighter-rouge">r10</code>, perhaps because it wanted to use <code class="language-plaintext highlighter-rouge">r13</code> for something else. Boqun Feng provided the following snippet which Zhouyi verified fixes the issue:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">rcu</span><span class="o">/</span><span class="nx">srcutree</span><span class="p">.</span><span class="nx">c</span> <span class="nx">b</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">rcu</span><span class="o">/</span><span class="nx">srcutree</span><span class="p">.</span><span class="nx">c</span>
        <span class="nx">index</span> <span class="nx">ab4ee58af84b</span><span class="p">..</span><span class="nx">f5ae3be3d04d</span> <span class="mi">100644</span>
        <span class="o">---</span> <span class="nx">a</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">rcu</span><span class="o">/</span><span class="nx">srcutree</span><span class="p">.</span><span class="nx">c</span>
        <span class="o">+++</span> <span class="nx">b</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">rcu</span><span class="o">/</span><span class="nx">srcutree</span><span class="p">.</span><span class="nx">c</span>
        <span class="p">@@</span> <span class="o">-</span><span class="mi">747</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">747</span><span class="p">,</span><span class="mi">7</span> <span class="p">@@</span> <span class="k">void</span> <span class="nx">__srcu_read_unlock_nmisafe</span><span class="p">(</span><span class="nx">struct</span> <span class="nx">srcu_struct</span> <span class="o">*</span><span class="nx">ssp</span><span class="p">,</span> <span class="nx">int</span> <span class="nx">idx</span><span class="p">)</span>

                <span class="nx">smp_mb__before_atomic</span><span class="p">();</span> <span class="cm">/* C */</span>  <span class="cm">/* Avoid leaking the critical section. */</span>
                <span class="nx">atomic_long_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sdp</span><span class="o">-&gt;</span><span class="nx">srcu_unlock_count</span><span class="p">[</span><span class="nx">idx</span><span class="p">]);</span>
        <span class="o">+</span>       <span class="nx">asm</span> <span class="nx">volatile</span><span class="p">(</span><span class="dl">""</span> <span class="p">:</span> <span class="p">:</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">r13</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">memory</span><span class="dl">"</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nx">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="nx">__srcu_read_unlock_nmisafe</span><span class="p">);</span>
</code></pre></div></div>

<p>In this snippet, <code class="language-plaintext highlighter-rouge">r13</code> is added to an extended inline asm statement, which instructs the compiler that <code class="language-plaintext highlighter-rouge">r13</code> may be clobbered by the asm statement, which hopefully prevents the compiler from caching its value before exiting the function. In fact this is exactly what prevents the issue.</p>

<p>Boqun also included a <code class="language-plaintext highlighter-rouge">memory</code> clobber which is equivalent to <code class="language-plaintext highlighter-rouge">barrier()</code> and is additional step which hopefully ensures memory access compiler optimizations donâ€™t span the inline assembly statement.</p>

<h3 id="finally-the-issue-is-clear">Finally the issue is clear</h3>

<p>Later in the email chain, I mentioned the series of events as outlined by Christophe and Boqun which could lead to the issue:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">The</span> <span class="nx">issue</span> <span class="nx">requires</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">ingredients</span><span class="p">:</span>
<span class="mi">1</span><span class="p">.</span> <span class="nx">Task</span> <span class="nx">A</span> <span class="nx">is</span> <span class="nx">running</span> <span class="nx">on</span> <span class="nx">CPU</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">task</span><span class="dl">'</span><span class="s1">s canary is copied into
the CPU1</span><span class="dl">'</span><span class="nx">s</span> <span class="nx">per</span><span class="o">-</span><span class="nx">cpu</span> <span class="nx">area</span> <span class="nx">pointed</span> <span class="nx">to</span> <span class="nx">by</span> <span class="nx">r13</span><span class="p">.</span>
<span class="mi">2</span><span class="p">.</span> <span class="nx">r13</span> <span class="nx">is</span> <span class="nx">now</span> <span class="nx">cached</span> <span class="nx">into</span> <span class="nx">r10</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">offending</span> <span class="kd">function</span> <span class="nx">due</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">compiler</span><span class="p">.</span>
<span class="mi">3</span><span class="p">.</span> <span class="nx">Task</span> <span class="nx">A</span> <span class="nx">running</span> <span class="nx">on</span> <span class="nx">CPU</span> <span class="mi">1</span> <span class="nx">now</span> <span class="nx">gets</span> <span class="nx">preempted</span> <span class="nx">right</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">middle</span> <span class="k">of</span>
<span class="nx">the</span> <span class="nx">offending</span> <span class="nx">SRCU</span> <span class="kd">function</span> <span class="nx">and</span> <span class="nx">gets</span> <span class="nx">migrated</span> <span class="nx">to</span> <span class="nx">CPU</span> <span class="mi">2</span><span class="p">.</span>
<span class="mi">4</span><span class="p">.</span>  <span class="nx">CPU</span> <span class="mi">2</span><span class="dl">'</span><span class="s1">s per-cpu canary is updated to that of task A since task A
is the current task now.
5. Task B now runs on CPU 1 and the per-cpu canary on CPU 1 is now that of B.
6. Task A exits the function, but stack checking code reads r10 which
contains CPU 1</span><span class="dl">'</span><span class="nx">s</span> <span class="nx">canary</span> <span class="nx">which</span> <span class="nx">is</span> <span class="nx">that</span> <span class="k">of</span> <span class="nx">task</span> <span class="nx">B</span><span class="o">!</span>
<span class="mi">7</span><span class="p">.</span> <span class="nx">Boom</span><span class="p">.</span>

<span class="nx">So</span> <span class="nx">the</span> <span class="nx">issue</span> <span class="nx">is</span> <span class="nx">precisely</span> <span class="k">in</span> <span class="err">#</span><span class="mi">2</span><span class="p">.</span>  <span class="nx">The</span> <span class="nx">issue</span> <span class="nx">is</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">compiler</span> <span class="nx">that</span> <span class="nx">it</span>
<span class="nx">does</span> <span class="nx">not</span> <span class="nx">treat</span> <span class="nx">r13</span> <span class="k">as</span> <span class="nx">volatile</span> <span class="k">as</span> <span class="nx">Boqun</span> <span class="nx">had</span> <span class="nx">initially</span> <span class="nx">mentioned</span><span class="p">.</span>
</code></pre></div></div>
<h2 id="how-do-we-fix-it">How do we fix it?</h2>

<p>My / our current take on it is it appears to be a compiler bug where the register <code class="language-plaintext highlighter-rouge">r13</code> is not considered volatile (which works for user land but not for the kernel). Seher Boessenkool who has worked on similar PPC64 issues before is on the email chain and can hopefully fix it in the compiler but lets see where it goes.</p>

<p>As a quick hack to fix this (as shown by Boqun above),<code class="language-plaintext highlighter-rouge">r13</code> can be added to an extended inline asm statement, which instructs the compiler that <code class="language-plaintext highlighter-rouge">r13</code> may be clobbered by the asm statement, hopefully preventing the compiler from caching its value before exiting the function.</p>

<h2 id="can-we-fix-it-in-the-kernel">Can we fix it in the kernel?</h2>

<p>According to Michael Ellerman, a possible solution would be to keep current in a register (GPR) on 64-bit, but weâ€™d need to do that in addition to the register reserved for the PACA, so that would consume another GPR which weâ€™d need to think hard about.</p>

<p>Thereâ€™s another reason to have the canary in the PACA, according to him: The PACA is always accessible, even when the MMU is off (because it is in a register), whereas <code class="language-plaintext highlighter-rouge">current</code> isnâ€™t (in some situations).</p>

<p>Even though, we prefer not to use stack protector in code that runs with the MMU off â€” if the canary wasnâ€™t in the PACA to begin with, then weâ€™d have a hard requirement to not use stack protector in code paths where the MMU is off.</p>
</div>
  
  


    </article>



<div class="pagination">
  

  <!-- Don't want numbers.
  
    
      <em>1</em>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <a href="/page5">5</a>
    
  
    
      <a href="/page6">6</a>
    
  
    
      <a href="/page7">7</a>
    
  
    
      <a href="/page8">8</a>
    
  
    
      <a href="/page9">9</a>
    
  
    
      <a href="/page10">10</a>
    
  
    
      <a href="/page11">11</a>
    
  
    
      <a href="/page12">12</a>
    
  
    
      <a href="/page13">13</a>
    
  
    
      <a href="/page14">14</a>
    
  
    
      <a href="/page15">15</a>
    
  
    
      <a href="/page16">16</a>
    
  
    
      <a href="/page17">17</a>
    
  
    
      <a href="/page18">18</a>
    
  
    
      <a href="/page19">19</a>
    
  
    
      <a href="/page20">20</a>
    
  
    
      <a href="/page21">21</a>
    
  
    
      <a href="/page22">22</a>
    
  
  -->

  
    <a href="/page2">Next Post&raquo;</a>
  
</div>


<!-- div blog-index -->
</div>


<aside class="sidebar">
  
    



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
